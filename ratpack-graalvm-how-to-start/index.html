<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="author" content="Szymon Stepniak"><meta name="robots" content="all"><title>Ratpack on GraalVM - how to start?</title><meta name="description" content="The journey inside the exciting world of GraalVM continues. Today I would like to share with you results of running Ratpack on GraalVM experiment. You are going to learn how to build a native binary of a simple &quot;Hello, World!&quot; Ratpack application. In t..."><meta name="keywords" content="ratpack,java,graalvm,native-image,non-blocking"><link rel="shortcut icon" type="image/png" href="/favicon_new.png"><link rel="dns-prefetch" href="//cdnjs.cloudflare.com"><link rel="dns-prefetch" href="//maxcdn.bootstrapcdn.com"><link rel="dns-prefetch" href="//disqus.com"><link rel="dns-prefetch" href="//c.disquscdn.com"><link rel="canonical" href="https://e.printstacktrace.blog/ratpack-graalvm-how-to-start/"><link rel="alternate" type="application/rss+xml" title="e.printStackTrace(); // Blog" href="/atom.xml"><link rel="preload" as="style" onload='this.onload=null,this.rel="stylesheet"' href="//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"><link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"><noscript><link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"></noscript><link rel="preload" as="style" onload='this.onload=null,this.rel="stylesheet"' href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/androidstudio.min.css"><link rel="stylesheet" href="/css/main.css?v=48"><link rel="preload" as="style" onload='this.onload=null,this.rel="stylesheet"' href="/css/conum.css?v=48"><noscript><link rel="stylesheet" href="/css/conum.css?v=48"></noscript><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic&amp;display=swap"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800&amp;display=swap"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Code+Pro&amp;display=swap"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Droid+Sans+Mono:400,700&amp;display=swap"><meta name="description" content="The journey inside the exciting world of GraalVM continues. Today I would like to share with you results of running Ratpack on GraalVM experiment. You are going to learn how to build a native binary o"><meta property="og:type" content="article"><meta property="og:title" content="Ratpack on GraalVM - how to start?"><meta property="og:url" content="https://e.printstacktrace.blog/ratpack-graalvm-how-to-start/"><meta property="og:site_name" content="e.printStackTrace(); &#x2F;&#x2F; Blog"><meta property="og:description" content="The journey inside the exciting world of GraalVM continues. Today I would like to share with you results of running Ratpack on GraalVM experiment. You are going to learn how to build a native binary o"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://e.printstacktrace.blog/images/og/ratpack-graalvm-how-to-start.jpg"><meta property="article:published_time" content="2019-02-15T02:10:39.000Z"><meta property="article:modified_time" content="2019-11-09T20:02:09.000Z"><meta property="article:author" content="Szymon Stepniak"><meta property="article:tag" content="ratpack"><meta property="article:tag" content="java"><meta property="article:tag" content="graalvm"><meta property="article:tag" content="native-image"><meta property="article:tag" content="non-blocking"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="https://e.printstacktrace.blog/images/og/ratpack-graalvm-how-to-start.jpg"><meta name="twitter:creator" content="@wololock"><script type="application/ld+json">{"@context":"http://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://e.printstacktrace.blog/ratpack-graalvm-how-to-start/"},"headline":"Ratpack on GraalVM - how to start?","image":{"@type":"ImageObject","url":"https://e.printstacktrace.blog/images/og/ratpack-graalvm-how-to-start.jpg"},"datePublished":"2019-02-15T02:10:39.000Z","dateModified":"2019-11-09T20:02:09.000Z","author":{"@type":"Person","name":"Szymon Stepniak"},"publisher":{"@type":"Organization","name":"e.printStackTrace(); // Blog","logo":{"@type":"ImageObject","url":"https://e.printstacktrace.blog/images/site-logo.jpg","height":60,"width":600}},"description":"The journey inside the exciting world of GraalVM continues. Today I would like to share with you results of running Ratpack on GraalVM experiment. You are going to learn how to build a native binary of a simple \"Hello, World!\" Ratpack application. In the end we are going to run some benchmarks to see if running GraalVM executable produces better results than running JAR on a regular Oracle JDK.","keywords":"ratpack,java,graalvm,native-image,non-blocking"}</script><meta name="generator" content="Hexo 4.2.1"><style>.img-lazyload-container{overflow:hidden;max-width:100%}.img-lazyload-container img{max-width:100%;display:block;height:auto;transition:opacity .5s ease-in-out}.img-lazyload-container img:not([src]){height:0;opacity:0}</style></head><body class="layout-post"><nav class="navbar navbar-default navbar-fixed-top navbar-custom"><div class="container-fluid"><div class="navbar-header"><button class="navbar-toggle" type="button" data-toggle="collapse" data-target="#main-navbar"><span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><a class="navbar-brand" href="/"><span>e.printStackTrace(); // Blog</span></a></div><div class="collapse navbar-collapse" id="main-navbar"><ul class="nav navbar-nav navbar-right"><li><a href="/archives">Archive</a></li><li><a href="https://github.com/wololock/wololock.github.io" target="_blank" rel="noopener">GitHub</a></li><li><a href="/youtube">YouTube</a></li><li><a class="stack-overflow" href="https://stackoverflow.com/users/2194470/szymon-stepniak?tab=profile" target="_blank" rel="noopener"><img class="so-icon" src="/img/so.png"><b class="rep">27,343</b><span class="badges"><span class="gold"><span class="b">●</span><span class="c">9</span></span><span class="silver"><span class="b">●</span><span class="c">61</span></span><span class="bronze"><span class="b">●</span><span class="c">94</span></span></span></a></li></ul></div></div></nav><header class="header-section"><div class="intro-header" style="background-image:url(/images/ratpack-cookbook-bg.jpg)"><div class="container"><div class="row"><div class="col-lg-10 col-lg-offset-1 col-md-10 col-md-offset-1"><div class="post-heading"><a class="category" href="/ratpack-cookbook/">Ratpack Cookbook</a><h1>Ratpack on GraalVM - how to start?</h1><div class="post-meta"><ul><li><time datetime="2019-02-15T02:10:39.000Z" itemprop="datePublished">Feb 15, 2019</time></li><li>19 minutes read</li><li><a href="https://e.printstacktrace.blog/ratpack-graalvm-how-to-start/#disqus_thread">0 Comments</a></li></ul><section class="post-tags"><ul class="tags"><li><a class="tag post-meta" href="/t/ratpack/">ratpack</a></li><li><a class="tag post-meta" href="/t/java/">java</a></li><li><a class="tag post-meta" href="/t/graalvm/">graalvm</a></li><li><a class="tag post-meta" href="/t/native-image/">native-image</a></li><li><a class="tag post-meta" href="/t/non-blocking/">non-blocking</a></li></ul></section></div></div></div></div></div></div></header><div class="container"><div class="row"><div class="col-lg-10 col-lg-offset-1 col-md-10 col-md-offset-1"><article class="blog-post" role="main"><div class="paragraph"><p>The journey inside the exciting world of <a href="https://www.graalvm.org/" target="_blank" rel="noopener">GraalVM</a> continues. Today I would like to share with you results of running <a href="https://ratpack.io/" target="_blank" rel="noopener">Ratpack</a> on GraalVM experiment. You are going to learn how to build a native binary of a simple "Hello, World!" Ratpack application. In the end we are going to run some benchmarks to see if running GraalVM executable produces better results than running JAR on a regular Oracle JDK.</p></div><a id="more"></a><div class="admonitionblock note"><table><tr><td class="icon"><i class="fa icon-note" title="Note"></i></td><td class="content">The source code of <em>ratpack-graalvm-demo</em> application can be found here <a href="https://github.com/wololock/ratpack-graalvm-demo" target="_blank" rel="noopener">wololock/ratpack-graalvm-demo</a></td></tr></table></div><div class="sect1"><h2 id="prerequisites">Prerequisites</h2><div class="sectionbody"><div class="paragraph"><p>Below you can find information about the GraalVM and Ratpack versions I used in the experiment:</p></div><div class="ulist"><ul><li><p><strong>GraalVM</strong> 19.2.1 (the most recent version available while writing this blog post)</p></li><li><p><strong>Ratpack</strong> 1.7.5</p></li></ul></div><div class="admonitionblock tip"><table><tr><td class="icon"><i class="fa icon-tip" title="Tip"></i></td><td class="content">Don&#8217;t know how to install GraalVM on your machine? With SDKMAN! installing GraalVM is as easy as executing the following command in the console <code>sdk install java 19.2.1.-grl</code>.</td></tr></table></div></div></div><div class="sect1"><h2 id="hello-world-application">Hello World application</h2><div class="sectionbody"><div class="paragraph"><p>We start the experiments with the most straightforward possible application - a good old Hello World app.</p></div><div class="listingblock"><div class="title">Listing 1. src/main/java/com/github/wololock/RatpackGraalDemoApp.java</div><div class="content"><pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package com.github.wololock;

import ratpack.server.RatpackServer;

import java.util.HashMap;
import java.util.Map;

import static ratpack.jackson.Jackson.json;

final class RatpackGraalDemoApp {

    public static void main(String[] args) throws Exception {
        final Map&lt;String, String&gt; message = new HashMap&lt;&gt;();
        message.put("message", "Hello, World!");

        RatpackServer.start(server -&gt;
                server.serverConfig(config -&gt; config.sysProps().development(false))
                        .handlers(chain -&gt; chain.get(ctx -&gt; ctx.render(json(message))))
        );
    }
}</code></pre></div></div><div class="admonitionblock note"><table><tr><td class="icon"><i class="fa icon-note" title="Note"></i></td><td class="content">You can bootstrap Ratpack app using Lazybones - <code>lazybones create ratpack your-app-name</code>.</td></tr></table></div><div class="paragraph"><p>When we send an HTTP request to the <code>localhost:5050</code> we get the following response:</p></div><div class="listingblock"><div class="title">Listing 2. HTTP response of <code>(GET) localhost:5050</code> request</div><div class="content"><pre class="highlightjs highlight"><code class="language-http hljs" data-lang="http">HTTP/1.1 200 OK
content-encoding: gzip
content-type: application/json
transfer-encoding: chunked

{
    "message": "Hello, World!"
}</code></pre></div></div></div></div><div class="sect1"><h2 id="preparing-for-graalvm">Preparing for GraalVM</h2><div class="sectionbody"><div class="admonitionblock note"><table><tr><td class="icon"><i class="fa icon-note" title="Note"></i></td><td class="content">GraalVM specific configuration got simplified enormously starting from Ratpack <code>1.7.0</code> release. This is the first version that used Netty <code>4.1.37</code>. Netty started providing <code>native-image.properties</code> and <code>reflection.json</code> files with version <code>4.1.36</code> which means that Netty-based applications does not have to configure Netty components for the GraalVM native image generation. This is a huge step forward.</td></tr></table></div><div class="paragraph"><p>We need to do some additional work to prepare our <em>"Hello World"</em> application for GraalVM.</p></div><div class="sect2"><h3 id="1-reflection-configuration">1. Reflection configuration</h3><div class="paragraph"><p>We start with preparing a configuration file for classes used via Java reflection mechanism. GraalVM uses <a href="https://github.com/oracle/graal/tree/master/substratevm" target="_blank" rel="noopener">Substrate VM</a> - a framework that allows aggressive ahead-of-time optimizations. All classes, methods or fields accessed via reflection have to be known at the compile time to make AOT compilation possible. Substrate VM resolves most of the basic reflection calls like <code>Class.forName(&#8230;&#8203;)</code>, but in more complex scenarios it requires additional information to be provided. In Ratpack basic "Hello World" application case we need to configure reflection access to the following two Caffeine Cache classes.</p></div><div class="listingblock"><div class="title">Listing 3. reflections.json</div><div class="content"><pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">[
  {
    "name": "com.github.benmanes.caffeine.cache.SSMS",
    "methods": [
      {
        "name": "&lt;init&gt;",
        "parameterTypes": ["com.github.benmanes.caffeine.cache.Caffeine", "com.github.benmanes.caffeine.cache.CacheLoader", "boolean"]
      }
    ]
  },
  {
    "name": "com.github.benmanes.caffeine.cache.PSMS",
    "methods": [
      {
        "name": "&lt;init&gt;"
      }
    ]
  }
]</code></pre></div></div><div class="paragraph"><p>In the case of our demo app we need to provide information about these 3 classes. <code>SSMS</code> and <code>PSMS</code> are Caffeine caching library generated classes that are used to initialize paths handler internal cache.</p></div></div><div class="sect2"><h3 id="2-dynamic-proxies-configuration">2. Dynamic proxies configuration</h3><div class="paragraph"><p>To make dependency injection via Guice possible, we need to <a href="https://github.com/oracle/graal/blob/master/substratevm/DYNAMIC_PROXY.md#manual-configuration" target="_blank" rel="noopener">generate dynamic proxies</a> at the compile time. It requires defining a list of interfaces that dynamic proxies implement. In our case, we only have to configure <code>java.lang.reflect.TypeVariable</code> interface.</p></div><div class="listingblock"><div class="title">Listing 4. proxies.json</div><div class="content"><pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">[
  ["java.lang.reflect.TypeVariable"]
]</code></pre></div></div></div><div class="sect2"><h3 id="3-unsafe-memory-access-configuration">3. Unsafe memory access configuration</h3><div class="paragraph"><p>Using <code>sun.misc.Unsafe</code> in Substrate VM generates <a href="https://github.com/oracle/graal/blob/master/substratevm/LIMITATIONS.md#unsafe-memory-access" target="_blank" rel="noopener">other limitations</a>. As Codrut Stancu explains in the <a href="https://medium.com/graalvm/instant-netty-startup-using-graalvm-native-image-generation-ed6f14ff7692" target="_blank" rel="noopener"><em>"Instant Netty Startup using GraalVM Native Image Generation"</em></a> article:</p></div><div class="quoteblock"><blockquote><div class="paragraph"><p>"Unsafe memory access through the <code>sun.misc.Unsafe</code> API is allowed in native executables, but field offset, array base offset, array index scale, and array index shift values need to be re-computed. These values are usually computed in the static initializer of a class and stored in static final fields. Static initializers are executed during build time, i.e., when the <code>native-image</code> tool runs. This means that the static fields store the field offsets computed by the JVM. However, Substrate VM uses a different object layout than the JVM, so using the values directly would access wrong memory locations. That leads to undefined behavior at run time. If you are lucky, your application crashes with a segmentation fault, if you are unlucky it just computes the wrong result.</p></div></blockquote></div><div class="paragraph"><p>In case of the simple "Hello World" Ratpack web application, there is one such class - <code>com.github.benmanes.caffeine.cache.UnsafeRefArrayAccess</code> <sup class="footnote">[<a id="_footnoteref_1" class="footnote" href="#_footnotedef_1" title="View footnote.">1</a>]</sup>. We can instruct Substrate VM to recompute <code>UnsafeRefArrayAccess.REF_ELEMENT_SHIFT</code> field by adding the following static class to our main application class.</p></div><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package com.github.wololock;

import com.oracle.svm.core.annotate.Alias;
import com.oracle.svm.core.annotate.RecomputeFieldValue;
import com.oracle.svm.core.annotate.TargetClass;
import ratpack.server.RatpackServer;

import java.util.HashMap;
import java.util.Map;

import static ratpack.jackson.Jackson.json;

final class RatpackGraalDemoApp {

    public static void main(String[] args) throws Exception {
        final Map&lt;String, String&gt; message = new HashMap&lt;&gt;();
        message.put("message", "Hello, World!");

        RatpackServer.start(server -&gt;
                server.serverConfig(config -&gt; config.sysProps().development(false))
                        .handlers(chain -&gt; chain.get(ctx -&gt; ctx.render(json(message))))
        );
    }

    @TargetClass(className = "com.github.benmanes.caffeine.cache.UnsafeRefArrayAccess")
    static final class Target_com_github_benmanes_caffeine_cache_UnsafeRefArrayAccess {
        @Alias
        @RecomputeFieldValue(kind = RecomputeFieldValue.Kind.ArrayIndexShift, declClass = Object[].class)
        public static int REF_ELEMENT_SHIFT;
    }
}</code></pre></div></div><div class="paragraph"><p>In this case we are using <a href="https://mvnrepository.com/artifact/com.oracle.substratevm/svm" target="_blank" rel="noopener">Substrate VM SDK</a> library which is added to our <code>build.gradle</code> file:</p></div><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">buildscript {
    repositories {
        jcenter()
    }
    dependencies {
        classpath "io.ratpack:ratpack-gradle:1.7.5"
        classpath "com.github.jengelman.gradle.plugins:shadow:5.1.0"
    }
}

apply plugin: "io.ratpack.ratpack-java"
apply plugin: "com.github.johnrengelman.shadow"
apply plugin: "idea"

repositories {
    jcenter()
}

mainClassName = 'com.github.wololock.RatpackGraalDemoApp'

dependencies {
    runtime 'org.slf4j:slf4j-simple:1.7.25'

    compile 'com.oracle.substratevm:svm:19.2.1' <i class="conum" data-value="1"></i><b>(1)</b>

    testCompile "org.spockframework:spock-core:1.0-groovy-2.4"
}</code></pre></div></div><div class="colist arabic"><table><tr><td><i class="conum" data-value="1"></i><b>1</b></td><td>Substrate VM SDK dependency.</td></tr></table></div></div></div></div><div class="sect1"><h2 id="building-native-binary">Building native binary</h2><div class="sectionbody"><div class="paragraph"><p>We are finally ready to compile native binary. We use the <code>native-image</code> command with the following parameters:</p></div><div class="listingblock"><div class="title">Listing 5. build-native-image.sh</div><div class="content"><pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">native-image --no-server \
    -jar build/libs/ratpack-graalvm-demo-all.jar \
    -H:Name=ratpack-graalvm-demo \
    -H:ReflectionConfigurationFiles=reflections.json \
    -H:DynamicProxyConfigurationFiles=proxies.json \
    --no-fallback \
    --enable-url-protocols=http \
    --report-unsupported-elements-at-runtime \
    --allow-incomplete-classpath \
    --initialize-at-run-time=io.netty.handler.codec.http.HttpObjectEncoder,io.netty.handler.ssl.ReferenceCountedOpenSslEngine,io.netty.handler.ssl.ReferenceCountedOpenSslClientContext,io.netty.handler.ssl.ReferenceCountedOpenSslServerContext,io.netty.handler.ssl.JdkNpnApplicationProtocolNegotiator,io.netty.handler.ssl.JettyNpnSslEngine,io.netty.handler.ssl.ConscryptAlpnSslEngine,io.netty.util.internal.logging.Log4JLogger,io.netty.internal.tcnative.CertificateVerifier,io.netty.internal.tcnative.SSL \
    --initialize-at-build-time \
    -Dratpack.epoll.disable=true <i class="conum" data-value="1"></i><b>(1)</b></code></pre></div></div><div class="paragraph"><p>As you can see in <em class="conum" data-value="1"></em> we disabled Epoll transport to use NIO instead. The reason for that is because <a href="https://github.com/oracle/graal/blob/master/substratevm/LIMITATIONS.md#java-native-interface-jni" target="_blank" rel="noopener">JNI support is limited</a> and at least at the moment all tries to run Ratpack with Epoll transport on Linux ends with the following exception:</p></div><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">[main] INFO ratpack.server.RatpackServer - Starting server...
Exception in thread "main" ratpack.api.UncheckedException: java.lang.reflect.InvocationTargetException
	at ratpack.util.Exceptions.uncheck(Exceptions.java:54)
	at ratpack.util.internal.TransportDetector$NativeTransportImpl.eventLoopGroup(TransportDetector.java:229)
	at ratpack.util.internal.TransportDetector$NativeTransport.eventLoopGroup(TransportDetector.java:133)
	at ratpack.util.internal.TransportDetector.eventLoopGroup(TransportDetector.java:65)
	at ratpack.exec.internal.DefaultExecController.&lt;init&gt;(DefaultExecController.java:61)
	at ratpack.server.internal.DefaultRatpackServer.start(DefaultRatpackServer.java:126)
	at ratpack.server.RatpackServer.start(RatpackServer.java:93)
	at com.github.wololock.RatpackGraalDemoApp.main(RatpackGraalDemoApp.java:12)
Caused by: java.lang.reflect.InvocationTargetException
	at java.lang.reflect.Constructor.newInstance(Constructor.java:423)
	at ratpack.util.internal.TransportDetector$NativeTransportImpl.eventLoopGroup(TransportDetector.java:227)
	... 6 more
Caused by: java.lang.UnsatisfiedLinkError: io.netty.channel.epoll.Native.epollCreate()I [symbol: Java_io_netty_channel_epoll_Native_epollCreate or Java_io_netty_channel_epoll_Native_epollCreate__]
	at com.oracle.svm.jni.access.JNINativeLinkage.getOrFindEntryPoint(JNINativeLinkage.java:145)
	at com.oracle.svm.jni.JNIGeneratedMethodSupport.nativeCallAddress(JNIGeneratedMethodSupport.java:54)
	at io.netty.channel.epoll.Native.epollCreate(Native.java)
	at io.netty.channel.epoll.Native.newEpollCreate(Native.java:107)
	at io.netty.channel.epoll.EpollEventLoop.&lt;init&gt;(EpollEventLoop.java:100)
	at io.netty.channel.epoll.EpollEventLoopGroup.newChild(EpollEventLoopGroup.java:135)
	at io.netty.channel.epoll.EpollEventLoopGroup.newChild(EpollEventLoopGroup.java:35)
	at io.netty.util.concurrent.MultithreadEventExecutorGroup.&lt;init&gt;(MultithreadEventExecutorGroup.java:84)
	at io.netty.util.concurrent.MultithreadEventExecutorGroup.&lt;init&gt;(MultithreadEventExecutorGroup.java:58)
	at io.netty.util.concurrent.MultithreadEventExecutorGroup.&lt;init&gt;(MultithreadEventExecutorGroup.java:47)
	at io.netty.channel.MultithreadEventLoopGroup.&lt;init&gt;(MultithreadEventLoopGroup.java:59)
	at io.netty.channel.epoll.EpollEventLoopGroup.&lt;init&gt;(EpollEventLoopGroup.java:104)
	at io.netty.channel.epoll.EpollEventLoopGroup.&lt;init&gt;(EpollEventLoopGroup.java:91)
	at io.netty.channel.epoll.EpollEventLoopGroup.&lt;init&gt;(EpollEventLoopGroup.java:68)</code></pre></div></div><div class="paragraph"><p>I will be exploring Epoll support and will post an update when get the working example of Ratpack application with Epoll transport on GraalVM.</p></div></div></div><div class="sect1"><h2 id="running-the-application">Running the application</h2><div class="sectionbody"><div class="paragraph"><p>At this point, we have <code>ratpack-graalvm-demo</code> binary file compiled and ready to use.</p></div><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">ratpack-graalvm-demo [master] % ls -lah ratpack-graalvm-demo
-rwxrwxr-x. 1 wololock wololock 24M 02-15 04:25 ratpack-graalvm-demo</code></pre></div></div><div class="paragraph"><p>As you can see a single <code>ratpack-graalvm-demo</code> file is 24 MB size. Let&#8217;s run it and execute HTTP request to see if it works.</p></div><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">ratpack-graalvm-demo [master] % ./ratpack-graalvm-demo
[main] INFO ratpack.server.RatpackServer - Starting server...
[main] INFO ratpack.server.RatpackServer - Building registry...
[main] INFO ratpack.server.RatpackServer - Ratpack started for http://localhost:5050</code></pre></div></div><div class="paragraph"><p>The first thing you will notice is that the server is ready almost instantly. Ratpack application run on a regular JVM starts quickly (in about 550-600 milliseconds), but this one starts in a blink of an eye.</p></div><div class="paragraph"><p>Let&#8217;s try to measure startup time of regular Java and GraalVM Ratpack application. I&#8217;m going to add <code>System.exit(0)</code> at the end of the <code>main</code> method, so the application shuts down right after it becomes ready to handle HTTP connections.</p></div><script id="asciicast-227675" src="https://asciinema.org/a/227675.js" async></script><div class="paragraph"><p>The difference is <strong>HUGE</strong>! Let&#8217;s compare best results - GraalVM&#8217;s best <strong>10</strong> milliseconds result versus Oracle JDK&#8217;s best <strong>581</strong> milliseconds result. It makes the difference.</p></div></div></div><div class="sect1"><h2 id="benchmark">Benchmark</h2><div class="sectionbody"><div class="paragraph"><p>Application startup time is one thing. It&#8217;s time to run a more critical comparison test. Let&#8217;s compare the throughput of both, GraalVM and Oracle JDK runtime environments.</p></div><div class="paragraph"><p>We will start with a small number of requests so that the Oracle JDK won’t have enough time to warm up properly. In this test, we use <a href="https://httpd.apache.org/docs/2.4/programs/ab.html" target="_blank" rel="noopener">Apache Bench</a> tool, and we execute 200 concurrent requests with a total of 1000 requests. Let’s start with GraalVM.</p></div><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-text hljs" data-lang="text">~ % ab -c 200 -n 1000 http://localhost:5050/
This is ApacheBench, Version 2.3 &lt;$Revision: 1826891 $&gt;
Copyright 1996 Adam Twiss, Zeus Technology Ltd, http://www.zeustech.net/
Licensed to The Apache Software Foundation, http://www.apache.org/

Benchmarking localhost (be patient)
Completed 100 requests
Completed 200 requests
Completed 300 requests
Completed 400 requests
Completed 500 requests
Completed 600 requests
Completed 700 requests
Completed 800 requests
Completed 900 requests
Completed 1000 requests
Finished 1000 requests


Server Software:
Server Hostname:        localhost
Server Port:            5050

Document Path:          /
Document Length:        27 bytes

Concurrency Level:      200
Time taken for tests:   0.090 seconds
Complete requests:      1000
Failed requests:        0
Total transferred:      117000 bytes
HTML transferred:       27000 bytes
Requests per second:    11153.00 [#/sec] (mean)
Time per request:       17.932 [ms] (mean)
Time per request:       0.090 [ms] (mean, across all concurrent requests)
Transfer rate:          1274.32 [Kbytes/sec] received

Connection Times (ms)
              min  mean[+/-sd] median   max
Connect:        0    4   1.2      4       6
Processing:     1    7   4.8      5      22
Waiting:        1    6   4.7      4      19
Total:          6   11   4.2      9      23

Percentage of the requests served within a certain time (ms)
  50%      9
  66%      9
  75%     10
  80%     12
  90%     20
  95%     22
  98%     22
  99%     22
 100%     23 (longest request)</code></pre></div></div><div class="paragraph"><p>That was fast. Now let&#8217;s see regular Oracle JDK in action.</p></div><div class="admonitionblock note"><table><tr><td class="icon"><i class="fa icon-note" title="Note"></i></td><td class="content">I start demo application with the following command <code>java -jar build/libs/ratpack-graalvm-demo-all.jar -Dratpack.epoll.disable=true</code></td></tr></table></div><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-text hljs" data-lang="text">ab -c 200 -n 1000 http://localhost:5050/
This is ApacheBench, Version 2.3 &lt;$Revision: 1826891 $&gt;
Copyright 1996 Adam Twiss, Zeus Technology Ltd, http://www.zeustech.net/
Licensed to The Apache Software Foundation, http://www.apache.org/

Benchmarking localhost (be patient)
Completed 100 requests
Completed 200 requests
Completed 300 requests
Completed 400 requests
Completed 500 requests
Completed 600 requests
Completed 700 requests
Completed 800 requests
Completed 900 requests
Completed 1000 requests
Finished 1000 requests


Server Software:
Server Hostname:        localhost
Server Port:            5050

Document Path:          /
Document Length:        27 bytes

Concurrency Level:      200
Time taken for tests:   0.335 seconds
Complete requests:      1000
Failed requests:        0
Total transferred:      117000 bytes
HTML transferred:       27000 bytes
Requests per second:    2985.77 [#/sec] (mean)
Time per request:       66.984 [ms] (mean)
Time per request:       0.335 [ms] (mean, across all concurrent requests)
Transfer rate:          341.15 [Kbytes/sec] received

Connection Times (ms)
              min  mean[+/-sd] median   max
Connect:        0    1   1.8      0       7
Processing:     5   29  13.3     25      98
Waiting:        5   29  13.3     25      94
Total:          5   30  13.7     25      98

Percentage of the requests served within a certain time (ms)
  50%     25
  66%     31
  75%     36
  80%     39
  90%     47
  95%     56
  98%     70
  99%     83
 100%     98 (longest request)</code></pre></div></div><div class="paragraph"><p>The difference between the cold Oracle JDK and GraalVM is enormous:</p></div><div class="ulist"><ul><li><p><strong>17.93</strong> ms vs. <strong>66.98</strong> ms mean time per request in GraalVM' favour.</p></li><li><p><strong>11153</strong> vs. <strong>2985</strong> requests per second in GraalVM&#8217;s favour.</p></li></ul></div><div class="paragraph"><p>However, let’s be fair - Oracle JDK shows its full potential when JIT jumps in and runs its optimizations. In the next round, we will let it warm up correctly and then we can compare the results. We will run 800 concurrent requests with a total of 500,000 requests, and we are going to do it twice - the first run is used to warm up the JVM so that we take only the second result into account. Let&#8217;s start with GraalVM.</p></div><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-text hljs" data-lang="text">ab -c 800 -n 500000 http://localhost:5050/
This is ApacheBench, Version 2.3 &lt;$Revision: 1826891 $&gt;
Copyright 1996 Adam Twiss, Zeus Technology Ltd, http://www.zeustech.net/
Licensed to The Apache Software Foundation, http://www.apache.org/

Benchmarking localhost (be patient)
Completed 50000 requests
Completed 100000 requests
Completed 150000 requests
Completed 200000 requests
Completed 250000 requests
Completed 300000 requests
Completed 350000 requests
Completed 400000 requests
Completed 450000 requests
Completed 500000 requests
Finished 500000 requests


Server Software:
Server Hostname:        localhost
Server Port:            5050

Document Path:          /
Document Length:        27 bytes

Concurrency Level:      800
Time taken for tests:   40.725 seconds
Complete requests:      500000
Failed requests:        0
Total transferred:      58500000 bytes
HTML transferred:       13500000 bytes
Requests per second:    12277.48 [#/sec] (mean)
Time per request:       65.160 [ms] (mean)
Time per request:       0.081 [ms] (mean, across all concurrent requests)
Transfer rate:          1402.80 [Kbytes/sec] received

Connection Times (ms)
              min  mean[+/-sd] median   max
Connect:        0   37 110.8     25    3130
Processing:     3   28   9.4     27     117
Waiting:        0   18   8.3     17      90
Total:         18   65 112.0     55    3156

Percentage of the requests served within a certain time (ms)
  50%     55
  66%     61
  75%     63
  80%     64
  90%     68
  95%     72
  98%     84
  99%   1072
 100%   3156 (longest request)</code></pre></div></div><div class="paragraph"><p>Now let&#8217;s do the same with Oracle JDK.</p></div><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-text hljs" data-lang="text">ab -c 800 -n 500000 http://localhost:5050/
This is ApacheBench, Version 2.3 &lt;$Revision: 1826891 $&gt;
Copyright 1996 Adam Twiss, Zeus Technology Ltd, http://www.zeustech.net/
Licensed to The Apache Software Foundation, http://www.apache.org/

Benchmarking localhost (be patient)
Completed 50000 requests
Completed 100000 requests
Completed 150000 requests
Completed 200000 requests
Completed 250000 requests
Completed 300000 requests
Completed 350000 requests
Completed 400000 requests
Completed 450000 requests
Completed 500000 requests
Finished 500000 requests


Server Software:
Server Hostname:        localhost
Server Port:            5050

Document Path:          /
Document Length:        27 bytes

Concurrency Level:      800
Time taken for tests:   35.889 seconds
Complete requests:      500000
Failed requests:        0
Total transferred:      58500000 bytes
HTML transferred:       13500000 bytes
Requests per second:    13931.95 [#/sec] (mean)
Time per request:       57.422 [ms] (mean)
Time per request:       0.072 [ms] (mean, across all concurrent requests)
Transfer rate:          1591.83 [Kbytes/sec] received

Connection Times (ms)
              min  mean[+/-sd] median   max
Connect:        0   28   8.1     27    1034
Processing:     2   30   7.7     30     249
Waiting:        0   17   6.9     16     242
Total:          6   57   5.3     57    1065

Percentage of the requests served within a certain time (ms)
  50%     57
  66%     58
  75%     59
  80%     60
  90%     62
  95%     64
  98%     66
  99%     68
 100%   1065 (longest request)</code></pre></div></div><div class="paragraph"><p>It looks like if we give Oracle JDK enough time to warm up, it runs a little bit more efficient than the GraalVM application. Take a look at these two charts to see the main difference.</p></div><div class="openblock text-center"><div class="content"><div class="imageblock img-responsive img-thumbnail"><div class="content"><a class="image" href="/images/ratpack-graalvm-rps-benchmark.png"><div class="img-lazyload-container" style="width:598px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==);background-repeat:no-repeat;background-position:center"><img data-original="/images/ratpack-graalvm-rps-benchmark.png" height="370" width="598" style="padding-top:61.87290969899666%"></div></a></div></div></div></div><div class="paragraph"><p>If we compare RPS between cold Oracle JDK and GraalVM, there is no doubt that GraalVM does better. However, if we only give a regular Oracle JDK a chance to warm up, it turns out that it can handle almost 1700 more requests. It&#8217;s a significant difference.</p></div><div class="openblock text-center"><div class="content"><div class="imageblock img-responsive img-thumbnail"><div class="content"><a class="image" href="/images/ratpack-graalvm-latency-benchmark.png"><div class="img-lazyload-container" style="width:596px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==);background-repeat:no-repeat;background-position:center"><img data-original="/images/ratpack-graalvm-latency-benchmark.png" height="368" width="596" style="padding-top:61.74496644295302%"></div></a></div></div></div></div><div class="paragraph"><p>Latency benchmark also reveals interesting details. GraalVM wins when we compare it to cold Oracle JDK, and we let both applications handle reasonably small traffic (200 requests with a total of 1000). When we increase the number of concurrent requests to 800, and we need to handle the total of 500,000 requests, warmed up Oracle JDK works much better. While GraalVM slows down to the ~65ms per request when we increase the traffic, Oracle JDK speeds up to ~57ms per request.</p></div><div class="paragraph"><p>There are also two things worth mentioning. I&#8217;ve tried to execute more concurrent requests, but it turned out that GraalVM starts throwing <code>IOException</code> when I increased the number of concurrent requests to 1,000.</p></div><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-text hljs" data-lang="text">[main] INFO ratpack.server.RatpackServer - Starting server...
[main] INFO ratpack.server.RatpackServer - Building registry...
[main] INFO ratpack.server.RatpackServer - Ratpack started for http://localhost:5050
[ratpack-compute-2-1] WARN io.netty.channel.DefaultChannelPipeline - An exceptionCaught() event was fired, and it reached at the tail of the pipeline. It usually means the last handler in the pipeline did not handle the exception.
java.io.IOException: Accept failed
	at com.oracle.svm.core.posix.PosixJavaNIOSubstitutions$Util_sun_nio_ch_ServerSocketChannelImpl.accept0(PosixJavaNIOSubstitutions.java:1261)
	at sun.nio.ch.ServerSocketChannelImpl.accept0(ServerSocketChannelImpl.java:1188)
	at sun.nio.ch.ServerSocketChannelImpl.accept(ServerSocketChannelImpl.java:422)
	at sun.nio.ch.ServerSocketChannelImpl.accept(ServerSocketChannelImpl.java:250)
	at io.netty.util.internal.SocketUtils$5.run(SocketUtils.java:110)
	at io.netty.util.internal.SocketUtils$5.run(SocketUtils.java:107)
	at java.security.AccessController.doPrivileged(AccessController.java:82)
	at io.netty.util.internal.SocketUtils.accept(SocketUtils.java:107)
	at io.netty.channel.socket.nio.NioServerSocketChannel.doReadMessages(NioServerSocketChannel.java:143)
	at io.netty.channel.nio.AbstractNioMessageChannel$NioMessageUnsafe.read(AbstractNioMessageChannel.java:75)
	at io.netty.channel.nio.NioEventLoop.processSelectedKey(NioEventLoop.java:656)
	at io.netty.channel.nio.NioEventLoop.processSelectedKeysPlain(NioEventLoop.java:556)
	at io.netty.channel.nio.NioEventLoop.processSelectedKeys(NioEventLoop.java:510)
	at io.netty.channel.nio.NioEventLoop.run(NioEventLoop.java:470)
	at io.netty.util.concurrent.SingleThreadEventExecutor$5.run(SingleThreadEventExecutor.java:909)
	at ratpack.exec.internal.DefaultExecController$ExecControllerBindingThreadFactory.lambda$newThread$0(DefaultExecController.java:137)
	at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)
	at java.lang.Thread.run(Thread.java:748)
	at com.oracle.svm.core.thread.JavaThreads.threadStartRoutine(JavaThreads.java:481)
	at com.oracle.svm.core.posix.thread.PosixJavaThreads.pthreadStartRoutine(PosixJavaThreads.java:193)</code></pre></div></div><div class="paragraph"><p>Oracle JDK at the same time was able to handle 1,000 concurrent requests without any issue.</p></div><div class="paragraph"><p>And the last thing - memory consumption. GraalVM does much better when it comes to memory consumption right after the startup - the demo application consumes around 30 MB after startup on GraalVM and about 90 MB when running on Oracle JDK. However, when the application starts handling firsts requests, memory consumptions jumps significantly - GraalVM consumes around 300 MB, while Oracle JDK consumes around 150 MB only.</p></div></div></div><div class="sect1"><h2 id="conclusion">Conclusion</h2><div class="sectionbody"><div class="paragraph"><p>I must admit that the final benchmark results surprised me a bit. This demo application is not a rock-solid proof - if we used much larger and much more complicated Ratpack application, we could get completely different results. It proved that in some use cases Ratpack application does not need GraalVM to run fast. GraalVM may offer much faster startup, but fine-tuned and adequately warmed up JDK may perform much better in terms of metrics like RPS or latency in milliseconds.</p></div><div class="paragraph"><p>Summary:</p></div><div class="ulist"><ul><li><p>GraalVM runs much faster compared to cold JDK. This is a good news for things like FaaS or running non-daemon like programs - you don&#8217;t have to wait until JIT does it job to optimize runtime environment.</p></li><li><p>GraalVM seems to allocate much more memory while running the demo program. It starts with much smaller memory footprint at the beginning, but when the benchmark is over, Oracle JDK consumed around 170 MB while GraalVM was consuming ~300 MB of the memory.</p></li></ul></div><div class="paragraph"><p>I hope you learned something new from this blog post. I’m pleased I have finally run the Ratpack example on GraalVM. It took me hours to make it running, and I almost gave up, but I couldn&#8217;t accept the failure. The final result makes me happy even more. It’s 06:03 AM. Time to go to sleep. See you soon!</p></div><div class="video-container"><iframe width="560" height="315" src="https://www.youtube.com/embed/aOszDmbSsyM" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></div></div></div><div class="sect1"><h2 id="updates">Updates</h2><div class="sectionbody"><div class="paragraph"><p>This blog gets updated whenever new version of GraalVM or Groovy gets released. Below you can find a list of all updates.</p></div><div class="ulist"><ul><li><p><strong class="mark">2019-11-07</strong>: Updated blog post to <strong>GraalVM</strong> <code>19.2.1</code> and <strong>Ratpack</strong> <code>1.7.5</code></p></li></ul></div><div class="row"><div class="col-12"><div id="newsletter-01"></div><script>function load_newsletter(e){var t=document.getElementById("newsletter-01");if(document.contains(t)){var n=t.parentElement;t.remove();var o=document.createElement("script");o.type="text/javascript",o.async=!0,o.src="https://tremendous-motivator-1432.ck.page/"+e+"/index.js",o.setAttribute("data-uid",e),n.appendChild(o)}}window.addEventListener("scroll",function(e){var t=document.scrollingElement.scrollTop,n=document.getElementById("newsletter-01");document.contains(n)&&t>n.offsetTop-500&&load_newsletter("5e86560171")})</script></div></div><h2 id="thank-you" class="discrete">Thank you!</h2><div class="paragraph"><p>If you read up to this point - leave me a comment below, so I can <strong>thank you</strong> in person for such an engagement. You can also share this blog post on <span class="icon color-twitter"><i class="fa fa-twitter"></i></span> <a href="https://twitter.com/intent/tweet?text=%22Ratpack%20on%20GraalVM%20-%20how%20to%20start?%22%20https://e.printstacktrace.blog/ratpack-graalvm-how-to-start/%20via%20@wololock" target="_blank" rel="noopener">Twitter</a>, <span class="icon color-facebook"><i class="fa fa-facebook-square"></i></span> <a href="https://www.facebook.com/sharer/sharer.php?u=https://e.printstacktrace.blog/ratpack-graalvm-how-to-start/&t=Ratpack%20on%20GraalVM%20-%20how%20to%20start?" target="_blank" rel="noopener">Facebook</a>, or <span class="icon color-linkedin"><i class="fa fa-linkedin-square"></i></span> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https://e.printstacktrace.blog/ratpack-graalvm-how-to-start/&title=Ratpack%20on%20GraalVM%20-%20how%20to%20start?" target="_blank" rel="noopener">LinkedIn</a> if you think other people can benefit from reading it. Thanks in advance!</p></div><div class="paragraph"><p>PS: Creating high-quality content takes a lot of time and effort. I want to deliver the best possible value to my readers and keep the blog always <strong>ad-free</strong>. If you have two more minutes, please take a look at this dedicated page where I listed a few different options to <a href="https://e.printstacktrace.blog/support-me" class="ga-track">support my efforts</a>. If my vision for the <em>e.printstacktrace.blog</em> development resonates with you, I will be grateful if you consider supporting me in this journey. <strong>Thank you! <span class="icon color-red"><i class="fa fa-heart"></i></span></strong></p></div></div></div><div id="footnotes"><hr><div class="footnote" id="_footnotedef_1"><a href="#_footnoteref_1">1</a>. <a href="https://github.com/ben-manes/caffeine/blob/v2.6.2/caffeine/src/main/java/com/github/benmanes/caffeine/cache/MpscGrowableArrayQueue.java#L594" target="_blank" rel="noopener" class="bare">https://github.com/ben-manes/caffeine/blob/v2.6.2/caffeine/src/main/java/com/github/benmanes/caffeine/cache/MpscGrowableArrayQueue.java#L594</a></div></div><footer class="post-footer"><img class="img-responsive img-circle" src="https://www.gravatar.com/avatar/b22c1842c6e8f7f2b9b3ed8c0d4efb4d?s=200"><div class="row author"><div class="col-lg-8 col-lg-offset-2 col-xs-10 col-xs-offset-1"><h4>Szymon Stepniak</h4><p><a class="stack-overflow" href="https://stackoverflow.com/users/2194470/szymon-stepniak?tab=profile" target="_blank" rel="noopener"><img class="so-icon" src="/img/so.png"><b class="rep">27,343</b><span class="badges"><span class="gold"><span class="b">●</span><span class="c">9</span></span><span class="silver"><span class="b">●</span><span class="c">61</span></span><span class="bronze"><span class="b">●</span><span class="c">94</span></span></span></a></p><p>Groovista, Upwork's Top Rated freelancer, Toruń Java User Group founder, open&nbsp;source contributor, Stack Overflow addict, bedroom guitar player. I walk through e.printStackTrace() so you don't have to.</p><ul class="social-links"><li><a href="https://feeds.feedburner.com/Eprintstacktracenet" target="_blank" rel="noopener" onclick="return window.open(this.href),!1"><span class="fa fa-rss"></span></a></li><li><a href="https://twitter.com/wololock" target="_blank" rel="noopener" onclick="return window.open(this.href),!1"><span class="fa fa-twitter"></span></a></li><li><a href="https://github.com/wololock" target="_blank" rel="noopener" onclick="return window.open(this.href),!1"><span class="fa fa-github"></span></a></li><li><a href="https://stackoverflow.com/users/2194470/szymon-stepniak?tab=profile" target="_blank" rel="noopener" onclick="return window.open(this.href),!1"><span class="fa fa-stack-overflow"></span></a></li><li><a href="https://www.youtube.com/c/eprintstacktrace" target="_blank" rel="noopener" onclick="return window.open(this.href),!1"><span class="fa fa-youtube"></span></a></li><li><a href="mailto:szymon.stepniak@gmail.com" onclick="return window.open(this.href),!1"><span class="fa fa-envelope"></span></a></li><li><a href="https://www.linkedin.com/in/szymon-stępniak-9a0b1630" target="_blank" rel="noopener" onclick="return window.open(this.href),!1"><span class="fa fa-linkedin"></span></a></li><li><a href="https://keybase.io/wololock" target="_blank" rel="noopener" onclick="return window.open(this.href),!1"><span class="fa fa-user-secret"></span></a></li></ul></div></div></footer><section class="related-posts"><h2>You may also like</h2><div class="row"><div class="col-lg-4"><a href="/graalvm-and-groovy-how-to-start/"><img class="img-responsive" src="/images/og/graalvm-groovy-how-to-start2.jpg"><h3>GraalVM and Groovy - how to start?</h3></a><p>GraalVM became one of the most popular topics in the JVM ecosystem. It promises the highest possible speed of running JVM-based programs (when compiled to native images), hand in hand with the smal...</p></div><div class="col-lg-4"><a href="/graalvm-heap-size-of-native-image-how-to-set-it/"><img class="img-responsive" src="/images/og/graalvm-heap-size.jpg"><h3>GraalVM and heap size of the native image - how to set it?</h3></a><p>In this short blog post, I would like to show you how to set a heap size of the application executed from the native image generated with GraalVM. We will also take a quick look at the effects caus...</p></div><div class="col-lg-4"><a href="/graalvm-native-image-inside-docker-container-does-it-make-sense/"><img class="img-responsive" src="/images/og/graalvm-docker-groovy.jpg"><h3>GraalVM native image inside docker container - does it make sense?</h3></a><p>We have learned how to create GraalVM native image from standalone Groovy script in the previous blog post. Today we continue the experiments, and this time we are going to create a Docker image to...</p></div></div></section></article><nav class="pagination" role="pagination"><a class="pull-left btn" href="/how-to-remove-class-annotation-groovy-compiler-configuration/">← Next post</a><a class="pull-right btn" href="/graalvm-native-image-inside-docker-container-does-it-make-sense/">Previous post →</a></nav><div class="disqus-comments"><div class="comments"><div id="disqus_thread"><div id="disqus_empty" style="display:none">Empty</div></div></div></div><script>function load_disqus(e){var t=document.getElementById("disqus_empty");if(document.contains(t)){var d=document.getElementById("disqus_thread"),n=document.createElement("script"),s=document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0];d&&t&&(t.remove(),n.type="text/javascript",n.async=!0,n.src="//"+e+".disqus.com/embed.js",s.appendChild(n))}}window.addEventListener("scroll",function(e){document.scrollingElement.scrollTop>document.getElementById("disqus_thread").offsetTop-500&&load_disqus("eprintstacktrace")},!1)</script></div></div></div><script async id="dsq-count-scr" src="//eprintstacktrace.disqus.com/count.js"></script><footer class="site-footer"><div class="container-fluid"><div class="row"><div class="col-lg-10 col-lg-offset-1 col-xs-10 col-xs-offset-1"><div class="row"><div class="col-lg-4"><h4 class="marked">Recent video on YouTube</h4><section class="recent-posts"><a href="https://www.youtube.com/watch?v=vJgcsyLJf0g" target="_blank" rel="noopener"><img class="img-thumbnail img-noborder" src="https://i3.ytimg.com/vi/vJgcsyLJf0g/mqdefault.jpg" alt="Brainf**k interpreter in Groovy (tail recursive implementation) | #groovylang"></a></section><h4>e.printstacktrace.blog © 2020</h4><p><em>"I walk through e.printStackTrace() so you don't have to"</em></p></div><div class="col-lg-4"><h4 class="marked">Recent articles</h4><section class="recent-posts"><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/parsing-json-from-curl-with-jq-basic-filters-and-functions-part-1/">Parsing JSON from curl with jq: basic filters and functions (part 1)</a></li><li class="post-list-item"><a class="post-list-link" href="/how-to-time-out-jenkins-pipeline-stage-and-keep-the-pipeline-running/">How to time out Jenkins Pipeline stage and keep the pipeline running?</a></li><li class="post-list-item"><a class="post-list-link" href="/my-first-200-youtube-subscribers-thank-you/">My first 200 YouTube subscribers - Thank You!</a></li><li class="post-list-item"><a class="post-list-link" href="/groovy-dynamic-maps-generic-type-erasure-and-raw-types/">Groovy dynamic Maps, generic type erasure, and raw types - an interesting use case to learn from</a></li><li class="post-list-item"><a class="post-list-link" href="/groovy-3-nullcheck-annotation-less-code-and-less-npe/">Groovy 3 @NullCheck annotation - less code and less NPE</a></li><li class="post-list-item"><a class="post-list-link" href="/groovy-3-string-gdk-improvements-takeright-takebetween-and-a-few-others/">Groovy 3 String GDK improvements - takeRight, takeBetween, and a few others</a></li></ul></section></div><div class="col-lg-4"><h4 class="marked">Stay connected</h4><div class="social-links"><ul><li><a href="https://feeds.feedburner.com/Eprintstacktracenet" target="_blank" rel="noopener" onclick="return window.open(this.href),!1"><span class="fa fa-rss"></span></a></li><li><a href="https://twitter.com/wololock" target="_blank" rel="noopener" onclick="return window.open(this.href),!1"><span class="fa fa-twitter"></span></a></li><li><a href="https://github.com/wololock" target="_blank" rel="noopener" onclick="return window.open(this.href),!1"><span class="fa fa-github"></span></a></li><li><a href="https://stackoverflow.com/users/2194470/szymon-stepniak?tab=profile" target="_blank" rel="noopener" onclick="return window.open(this.href),!1"><span class="fa fa-stack-overflow"></span></a></li><li><a href="https://www.youtube.com/c/eprintstacktrace" target="_blank" rel="noopener" onclick="return window.open(this.href),!1"><span class="fa fa-youtube"></span></a></li><li><a href="mailto:szymon.stepniak@gmail.com" onclick="return window.open(this.href),!1"><span class="fa fa-envelope"></span></a></li><li><a href="https://www.linkedin.com/in/szymon-stępniak-9a0b1630" target="_blank" rel="noopener" onclick="return window.open(this.href),!1"><span class="fa fa-linkedin"></span></a></li><li><a href="https://keybase.io/wololock" target="_blank" rel="noopener" onclick="return window.open(this.href),!1"><span class="fa fa-user-secret"></span></a></li></ul></div><h4 class="marked">Most popular tags</h4><section class="tagcloud"><a href="/t/affiliate/" style="font-size:12pt;color:#777">affiliate</a> <a href="/t/async/" style="font-size:8pt;color:#6a6a6a">async</a> <a href="/t/benchmark/" style="font-size:12pt;color:#777">benchmark</a> <a href="/t/book/" style="font-size:16pt;color:#858585">book</a> <a href="/t/cicd/" style="font-size:24pt;color:#9f9f9f">cicd</a> <a href="/t/devops/" style="font-size:16pt;color:#858585">devops</a> <a href="/t/docker/" style="font-size:12pt;color:#777">docker</a> <a href="/t/github/" style="font-size:8pt;color:#6a6a6a">github</a> <a href="/t/graalvm/" style="font-size:24pt;color:#9f9f9f">graalvm</a> <a href="/t/groovy/" style="font-size:32pt;color:#bababa">groovy</a> <a href="/t/java/" style="font-size:28pt;color:#adadad">java</a> <a href="/t/jenkins/" style="font-size:20pt;color:#929292">jenkins</a> <a href="/t/jenkins-pipeline/" style="font-size:20pt;color:#929292">jenkins-pipeline</a> <a href="/t/jmh/" style="font-size:16pt;color:#858585">jmh</a> <a href="/t/junit/" style="font-size:8pt;color:#6a6a6a">junit</a> <a href="/t/micronaut/" style="font-size:12pt;color:#777">micronaut</a> <a href="/t/native-image/" style="font-size:12pt;color:#777">native-image</a> <a href="/t/non-blocking/" style="font-size:12pt;color:#777">non-blocking</a> <a href="/t/ratpack/" style="font-size:24pt;color:#9f9f9f">ratpack</a> <a href="/t/review/" style="font-size:16pt;color:#858585">review</a> <a href="/t/rxjava/" style="font-size:8pt;color:#6a6a6a">rxjava</a> <a href="/t/sdkman/" style="font-size:12pt;color:#777">sdkman</a> <a href="/t/spock/" style="font-size:12pt;color:#777">spock</a> <a href="/t/string/" style="font-size:8pt;color:#6a6a6a">string</a> <a href="/t/unit-test/" style="font-size:12pt;color:#777">unit-test</a></section></div></div></div></div><div class="row"><div class="col-lg-10 col-lg-offset-1 col-xs-10 col-xs-offset-1 text-center"><ul class="footer-links"><li><a href="/privacy-policy/">Privacy policy</a></li><li><a href="/support-me/">Support me</a></li><li><a href="http://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener"><img src="https://badgen.net/badge/license/CC%20BY-NC-SA%204.0/gray"></a></li><li><a href="https://github.com/wololock/wololock.github.io/commits/develop" target="_blank" rel="noopener"><img src="https://badgen.net/github/last-commit/wololock/wololock.github.io?color=blue"></a></li></ul></div></div></div><section class="poweredby"><ul class="text-center"><li><span>Published with </span><a href="https://hexo.io" target="_blank" rel="noopener" onclick="return window.open(this.href),!1"><img src="/img/logo-hexo.png"></a></li><li><span>Hosted on </span><a href="https://github.com/wololock/wololock.github.io" target="_blank" rel="noopener" onclick="return window.open(this.href),!1"><img src="/img/logo-github.png"></a></li><li><span>Deployed with </span><a href="https://circleci.com/gh/wololock/wololock.github.io" target="_blank" rel="noopener" onclick="return window.open(this.href),!1"><img src="/img/logo-circleci.png"></a></li></ul></section></footer><script src="//cdnjs.cloudflare.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script><script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script><script async id="cookiebanner" src="//cdnjs.cloudflare.com/ajax/libs/cookie-banner/1.2.2/cookiebanner.min.js" data-moreinfo="/privacy-policy/" data-message="This blog uses cookies to enhance your experience. By continuing to visit it you agree to its use of cookies." data-link="#ffad33" data-font-family="Lora,serif" data-font-size="1.6rem" data-bg="#444"></script><script src="/js/main.js?v=5"></script><script src="/js/highlight.pack.js?v=9.18.1"></script><script>hljs.initHighlightingOnLoad()</script><script>"localhost"!==window.location.hostname&&"127.0.0.1"!==window.location.hostname&&(!function(a,e,t,n,o,c,i){a.GoogleAnalyticsObject=o,a.ga=a.ga||function(){(a.ga.q=a.ga.q||[]).push(arguments)},a.ga.l=1*new Date,c=e.createElement(t),i=e.getElementsByTagName(t)[0],c.async=1,c.src="//www.google-analytics.com/analytics.js",i.parentNode.insertBefore(c,i)}(window,document,"script",0,"ga"),ga("create","UA-42400890-5","auto"),ga("send","pageview"),jQuery("a.ga-track").click(function(a){var e=jQuery(a.target).text();return ga("send","event","affiliate","click",e),!0}))</script><script>!function(){"use strict";function r(e){var t=e.getAttribute("data-original"),n=new Image;n.onload=function(){e.setAttribute("src",t),e.style.paddingTop=""},n.src=t}document.addEventListener("DOMContentLoaded",function(){var t,e,n,i=Array.prototype.slice.call(document.querySelectorAll("img[data-original]"));i.length&&("undefined"!=typeof IntersectionObserver?(t=new IntersectionObserver(function(e,t){e.filter(function(e){return e.isIntersecting}).forEach(function(e){r(e.target),t.unobserve(e.target)})}),i.forEach(function(e){t.observe(e)})):(n=function(){clearTimeout(e),e=setTimeout(function(){if(!(i=i.filter(function(e){return!e.src})).length)return window.removeEventListener("scroll",n),void window.removeEventListener("resize",n);i.filter(function(e){e.getBoundingClientRect().top<window.innerHeight&&r(e)})},100)},window.addEventListener("scroll",n),window.addEventListener("resize",n),n()))},!1)}();</script></body></html>