<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="author" content="Szymon Stepniak"><meta name="robots" content="all"><title>GraalVM and Groovy - how to start?</title><meta name="description" content="GraalVM became one of the most popular topics in the JVM ecosystem. It promises the highest possible speed of running JVM-based programs (when compiled to native images), hand in hand with the smaller memory footprint. It sounds interesting enough to g..."><meta name="keywords" content="groovy,java,graalvm,native-image"><link rel="shortcut icon" type="image/png" href="/favicon_new.png"><link rel="dns-prefetch" href="//cdnjs.cloudflare.com"><link rel="dns-prefetch" href="//maxcdn.bootstrapcdn.com"><link rel="dns-prefetch" href="//disqus.com"><link rel="dns-prefetch" href="//c.disquscdn.com"><link rel="canonical" href="https://e.printstacktrace.blog/graalvm-and-groovy-how-to-start/"><link rel="alternate" type="application/rss+xml" title="e.printStackTrace(); // Blog" href="/atom.xml"><link rel="preload" as="style" onload='this.onload=null,this.rel="stylesheet"' href="//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"><link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"><noscript><link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"></noscript><link rel="preload" as="style" onload='this.onload=null,this.rel="stylesheet"' href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/androidstudio.min.css"><link rel="stylesheet" href="/css/main.css?v=48"><link rel="preload" as="style" onload='this.onload=null,this.rel="stylesheet"' href="/css/conum.css?v=48"><noscript><link rel="stylesheet" href="/css/conum.css?v=48"></noscript><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic&amp;display=swap"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800&amp;display=swap"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Code+Pro&amp;display=swap"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Droid+Sans+Mono:400,700&amp;display=swap"><meta name="description" content="GraalVM became one of the most popular topics in the JVM ecosystem. It promises the highest possible speed of running JVM-based programs (when compiled to native images), hand in hand with the smaller"><meta property="og:type" content="article"><meta property="og:title" content="GraalVM and Groovy - how to start?"><meta property="og:url" content="https://e.printstacktrace.blog/graalvm-and-groovy-how-to-start/"><meta property="og:site_name" content="e.printStackTrace(); &#x2F;&#x2F; Blog"><meta property="og:description" content="GraalVM became one of the most popular topics in the JVM ecosystem. It promises the highest possible speed of running JVM-based programs (when compiled to native images), hand in hand with the smaller"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://e.printstacktrace.blog/images/og/graalvm-groovy-how-to-start2.jpg"><meta property="article:published_time" content="2018-10-03T21:28:49.000Z"><meta property="article:modified_time" content="2019-11-22T21:14:49.000Z"><meta property="article:author" content="Szymon Stepniak"><meta property="article:tag" content="groovy"><meta property="article:tag" content="java"><meta property="article:tag" content="graalvm"><meta property="article:tag" content="native-image"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="https://e.printstacktrace.blog/images/og/graalvm-groovy-how-to-start2.jpg"><meta name="twitter:creator" content="@wololock"><script type="application/ld+json">{"@context":"http://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://e.printstacktrace.blog/graalvm-and-groovy-how-to-start/"},"headline":"GraalVM and Groovy - how to start?","image":{"@type":"ImageObject","url":"https://e.printstacktrace.blog/images/og/graalvm-groovy-how-to-start2.jpg"},"datePublished":"2018-10-03T21:28:49.000Z","dateModified":"2019-11-22T21:14:49.000Z","author":{"@type":"Person","name":"Szymon Stepniak"},"publisher":{"@type":"Organization","name":"e.printStackTrace(); // Blog","logo":{"@type":"ImageObject","url":"https://e.printstacktrace.blog/images/site-logo.jpg","height":60,"width":600}},"description":"GraalVM became one of the most popular topics in the JVM ecosystem. It promises the highest possible speed of running JVM-based programs (when compiled to native images), hand in hand with the smaller memory footprint. It sounds interesting enough to give it a try. And today we are going to play around a little bit with running simple Groovy program after compiling to a standalone native image.","keywords":"groovy,java,graalvm,native-image"}</script><meta name="generator" content="Hexo 4.2.1"><style>.img-lazyload-container{overflow:hidden;max-width:100%}.img-lazyload-container img{max-width:100%;display:block;height:auto;transition:opacity .5s ease-in-out}.img-lazyload-container img:not([src]){height:0;opacity:0}</style></head><body class="layout-post"><nav class="navbar navbar-default navbar-fixed-top navbar-custom"><div class="container-fluid"><div class="navbar-header"><button class="navbar-toggle" type="button" data-toggle="collapse" data-target="#main-navbar"><span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><a class="navbar-brand" href="/"><span>e.printStackTrace(); // Blog</span></a></div><div class="collapse navbar-collapse" id="main-navbar"><ul class="nav navbar-nav navbar-right"><li><a href="/archives">Archive</a></li><li><a href="https://github.com/wololock/wololock.github.io" target="_blank" rel="noopener">GitHub</a></li><li><a href="/youtube">YouTube</a></li><li><a class="stack-overflow" href="https://stackoverflow.com/users/2194470/szymon-stepniak?tab=profile" target="_blank" rel="noopener"><img class="so-icon" src="/img/so.png"><b class="rep">27,343</b><span class="badges"><span class="gold"><span class="b">●</span><span class="c">9</span></span><span class="silver"><span class="b">●</span><span class="c">61</span></span><span class="bronze"><span class="b">●</span><span class="c">94</span></span></span></a></li></ul></div></div></nav><header class="header-section"><div class="intro-header" style="background-image:url(/images/graalvm-groovy-revisited.jpg)"><div class="container"><div class="row"><div class="col-lg-10 col-lg-offset-1 col-md-10 col-md-offset-1"><div class="post-heading"><a class="category" href="/groovy-cookbook/">Groovy Cookbook</a><h1>GraalVM and Groovy - how to start?</h1><div class="post-meta"><ul><li><time datetime="2018-10-03T21:28:49.000Z" itemprop="datePublished">Oct 3, 2018</time></li><li>21 minutes read</li><li><a href="https://e.printstacktrace.blog/graalvm-and-groovy-how-to-start/#disqus_thread">0 Comments</a></li></ul><section class="post-tags"><ul class="tags"><li><a class="tag post-meta" href="/t/groovy/">groovy</a></li><li><a class="tag post-meta" href="/t/java/">java</a></li><li><a class="tag post-meta" href="/t/graalvm/">graalvm</a></li><li><a class="tag post-meta" href="/t/native-image/">native-image</a></li></ul></section></div></div></div></div></div></div></header><div class="container"><div class="row"><div class="col-lg-10 col-lg-offset-1 col-md-10 col-md-offset-1"><article class="blog-post" role="main"><div class="paragraph"><p><a href="https://www.graalvm.org/" target="_blank" rel="noopener">GraalVM</a> became one of the most popular topics in the JVM ecosystem. It promises the highest possible speed of running JVM-based programs (when compiled to native images), hand in hand with the smaller memory footprint. It sounds interesting enough to give it a try. And today we are going to play around a little bit with running simple Groovy program after compiling to a standalone native image.</p></div><a id="more"></a><div class="sect1"><h2 id="introduction">Introduction</h2><div class="sectionbody"><div class="paragraph"><p>This blog post documents pretty simple use case of running Groovy code compiled to a GraalVM native image. It will give you a good understanding how to start and how to solve the problems you will most probably face when you start playing around with your own examples.</p></div></div></div><div class="sect1"><h2 id="prerequisites">Prerequisites</h2><div class="sectionbody"><div class="paragraph"><p>We will be using following tools:</p></div><div class="ulist"><ul><li><p><strong>GraalVM</strong> <code>19.2.1</code> <em>(updated: 2019-11-07T19:37:33+0100)</em></p></li><li><p><strong>Groovy</strong> <code>2.5.8</code></p></li></ul></div><div class="admonitionblock tip"><table><tr><td class="icon"><i class="fa icon-tip" title="Tip"></i></td><td class="content">The easiest way to install GraalVM and Groovy is to use <a href="https://sdkman.io/" target="_blank" rel="noopener">SDKMAN!</a> command line tool.</td></tr></table></div><div class="admonitionblock important"><table><tr><td class="icon"><i class="fa icon-important" title="Important"></i></td><td class="content"><div class="paragraph"><p>The <code>native-image</code> from <strong>GraalVM</strong> <code>19.3.0</code> does not compile this specific Groovy code and fails with the <code>undefined reference to `JVM_GetMethodTypeAnnotations'</code> and <code>undefined reference to `JVM_GetMethodParameters'</code>.</p></div><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-text hljs" data-lang="text">/opt/graalvm-ce-java8-19.3.0/jre/lib/libjava.a(Executable.o): In function `Java_java_lang_reflect_Executable_getTypeAnnotationBytes0':
/opt/jprt/T/P1/225159.buildslave/s/jdk/src/share/native/java/lang/reflect/Executable.c:39: undefined reference to `JVM_GetMethodTypeAnnotations'
/opt/graalvm-ce-java8-19.3.0/jre/lib/libjava.a(Executable.o): In function `Java_java_lang_reflect_Executable_getParameters0':
/opt/jprt/T/P1/225159.buildslave/s/jdk/src/share/native/java/lang/reflect/Executable.c:33: undefined reference to `JVM_GetMethodParameters'
collect2: error: ld returned 1 exit status</code></pre></div></div><div class="paragraph"><p>It is most probably related to the changes introduced in 19.3.0 to the <code>native-image</code> compiler<sup class="footnote">[<a id="_footnoteref_1" class="footnote" href="#_footnotedef_1" title="View footnote.">1</a>]</sup>.</p></div><div class="paragraph"><p>The issue was reported here - <a href="https://github.com/oracle/graal/issues/1875" target="_blank" rel="noopener" class="bare">https://github.com/oracle/graal/issues/1875</a></p></div></td></tr></table></div><div class="paragraph"><p>Let&#8217;s make sure we are using correct GraalVM Java distribution.</p></div><div class="listingblock"><div class="title">Listing 1. Checking Java version</div><div class="content"><pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ java -version
openjdk version "1.8.0_232"
OpenJDK Runtime Environment (build 1.8.0_232-20191008104205.buildslave.jdk8u-src-tar--b07)
OpenJDK 64-Bit GraalVM CE 19.2.1 (build 25.232-b07-jvmci-19.2-b03, mixed mode)</code></pre></div></div><div class="paragraph"><p>Starting from 19.0.0 version, GraalVM does not contain <code>native-image</code> tool as a default part of the distribution, so we need to install it using GraalVM Component Updater.</p></div><div class="listingblock"><div class="title">Listing 2. Installing <code>native-image</code> using <code>gu</code> (a tool shipped with GraalVM distribution)</div><div class="content"><pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ gu install native-image

Downloading: Component catalog from www.graalvm.org
Processing component archive: Native Image
Downloading: Component native-image: Native Image  from github.com
Installing new component: Native Image (org.graalvm.native-image, version 19.2.1)</code></pre></div></div><div class="paragraph"><p>Let&#8217;s check if we use a proper version of Groovy.</p></div><div class="listingblock"><div class="title">Listing 3. Checking Groovy version</div><div class="content"><pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ groovy -version
Groovy Version: 2.5.8 JVM: 1.8.0_232 Vendor: Oracle Corporation OS: Linux</code></pre></div></div><div class="paragraph"><p>Let&#8217;s also check if <code>GROOVY_HOME</code> variable is set correctly. (If you installed Groovy using SDKMAN!, the environment variable should be set correctly.)</p></div><div class="listingblock"><div class="title">Listing 4. Checking if <code>GROOVY_HOME</code> environment variable is set</div><div class="content"><pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ env | grep GROOVY_HOME
GROOVY_HOME=/home/wololock/.sdkman/candidates/groovy/current</code></pre></div></div><div class="paragraph"><p>We are all set and ready to code!</p></div></div></div><div class="sect1"><h2 id="an-example">An example</h2><div class="sectionbody"><div class="paragraph"><p>For the purpose of this experiment we are going to use a simple Groovy program that sums and multiplies numbers:</p></div><div class="listingblock"><div class="title">Listing 5. RandomNumber.groovy</div><div class="content"><pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">class RandomNumber {
    static void main(String[] args) {
        def random = new Random().nextInt(1000)

        println "The random number is: $random"

        def sum = (0..random).sum { int num -&gt; num * 2 }

        println "The doubled sum of numbers between 0 and $random is $sum"
    }
}</code></pre></div></div><div class="paragraph"><p>GraalVM prefers static compilation<sup class="footnote">[<a id="_footnoteref_2" class="footnote" href="#_footnotedef_2" title="View footnote.">2</a>]</sup>, thus we need to switch Groovy from dynamic to a static compilation. We can simply put <code>@groovy.transform.CompileStatic</code> annotation over the class definition in <code>RandomNumber.groovy</code> file, or we can create a compiler configuration file that adds this annotation to all classes.</p></div><div class="listingblock"><div class="title">Listing 6. Compiler configuration file <code>compiler.groovy</code></div><div class="content"><pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">withConfig(configuration) {
    ast(groovy.transform.CompileStatic)
}</code></pre></div></div><div class="paragraph"><p>We are ready to compile our code with <code>groovyc</code> compiler:</p></div><div class="listingblock"><div class="title">Listing 7. Compiling Groovy code</div><div class="content"><pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">groovyc --configscript compiler.groovy RandomNumber.groovy</code></pre></div></div><div class="paragraph"><p>The code compiled. We can now test if our Groovy script runs as a Java program.</p></div><div class="listingblock"><div class="title">Listing 8. Running Java program with GraalVM</div><div class="content"><pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ java -cp ".:$GROOVY_HOME/lib/groovy-2.5.8.jar" RandomNumber
The random number is: 313
The doubled sum of numbers between 0 and 313 is 98282</code></pre></div></div><div class="paragraph"><p>It run smoothly! You have probably noticed a small lag - the result was not printed instantly to the console. We can run the program again, but this time with the <code>time</code> command added to measure execution time.</p></div><div class="listingblock"><div class="title">Listing 9. Measuring Java program execution time</div><div class="content"><pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ time java -cp ".:$GROOVY_HOME/lib/groovy-2.5.8.jar" RandomNumber
The random number is: 859
The doubled sum of numbers between 0 and 859 is 738740

real	0m0,306s
user	0m0,692s
sys	0m0,073s</code></pre></div></div><div class="paragraph"><p>It took <strong>306 ms</strong> to complete. Is it slow or fast? It depends. If we compare it to the same program, but executed inside Groovy interpreter command line tool, the Java program is approximately <strong>2.5 times faster</strong>.</p></div><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ time groovy RandomNumber.groovy
The random number is: 711
The doubled sum of numbers between 0 and 711 is 506232

real	0m0,885s
user	0m2,060s
sys	0m0,183s</code></pre></div></div><div class="paragraph"><p>Let&#8217;s see if GraalVM&#8217;s native image can do better than that.</p></div></div></div><div class="sect1"><h2 id="creating-native-image">Creating native image</h2><div class="sectionbody"><div class="paragraph"><p>One of the most interesting features of GraalVM is its <a href="https://www.graalvm.org/docs/reference-manual/aot-compilation/" target="_blank" rel="noopener">ability to create standalone native binary file</a> from given Java bytecode (either Java <code>.class</code> or <code>.jar</code> files).</p></div><div class="paragraph"><p>Running our example inside the JVM was nice, but GraalVM offers much more. We can create standalone native image that will consume much less memory and will execute in a blink of an eye. Let&#8217;s give it a try:</p></div><div class="listingblock"><div class="title">Listing 10. Building native image with GraalVM</div><div class="content"><pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ native-image --allow-incomplete-classpath \ <i class="conum" data-value="1"></i><b>(1)</b>
    --report-unsupported-elements-at-runtime \ <i class="conum" data-value="2"></i><b>(2)</b>
    --initialize-at-build-time \ <i class="conum" data-value="3"></i><b>(3)</b>
    --initialize-at-run-time=org.codehaus.groovy.control.XStreamUtils,groovy.grape.GrapeIvy \ <i class="conum" data-value="4"></i><b>(4)</b>
    --no-fallback \ <i class="conum" data-value="5"></i><b>(5)</b>
    --no-server \ <i class="conum" data-value="6"></i><b>(6)</b>
    -cp ".:$GROOVY_HOME/lib/groovy-2.5.8.jar" \ <i class="conum" data-value="7"></i><b>(7)</b>
    RandomNumber <i class="conum" data-value="8"></i><b>(8)</b></code></pre></div></div><div class="paragraph"><p>As you can see there are many parameters passed to the <code>native-image</code> command. We use <em class="conum" data-value="1"></em> to allow image building with an incomplete classpath. If we didn&#8217;t allow that, native image compilation would fail with the error like the one below.</p></div><div class="listingblock"><div class="title">Listing 11. Compilation error thrown when <code>--allow-incomplete-classpath</code> parameter is missing</div><div class="content"><pre class="highlightjs highlight"><code class="language-text hljs" data-lang="text">Error: com.oracle.graal.pointsto.constraints.UnresolvedElementException: Discovered unresolved method during parsing: org.codehaus.groovy.control.XStreamUtils.serialize(java.lang.String, java.lang.Object). To diagnose the issue you can use the --allow-incomplete-classpath option. The missing method is then reported at run time when it is accessed the first time.</code></pre></div></div><div class="paragraph"><p>The second parameter <em class="conum" data-value="2"></em> makes usages of unsupported methods and fields to be reported at a runtime (when they are accessed the first time) instead of the build time. It is also critical to our case. Without this parameter set, compilation fails with the following error.</p></div><div class="listingblock"><div class="title">Listing 12. Compilation error thrown when <code>--report-unsupported-elements-at-runtime</code> parameter is missing</div><div class="content"><pre class="highlightjs highlight"><code class="language-text hljs" data-lang="text">Error: Unsupported features in 5 methods
Detailed message:
Error: com.oracle.svm.hosted.substitute.DeletedElementException: Unsupported method java.lang.ClassLoader.defineClass(String, byte[], int, int) is reachable: The declaring class of this element has been substituted, but this element is not present in the substitution class
...
Error: com.oracle.svm.hosted.substitute.DeletedElementException: Unsupported method java.lang.ClassLoader.defineClass(String, byte[], int, int, ProtectionDomain) is reachable: The declaring class of this element has been substituted, but this element is not present in the substitution class
...
Error: com.oracle.svm.hosted.substitute.DeletedElementException: Unsupported method java.lang.ClassLoader.findLoadedClass(String) is reachable: The declaring class of this element has been substituted, but this element is not present in the substitution class
...
Error: com.oracle.svm.hosted.substitute.DeletedElementException: Unsupported method java.lang.ClassLoader.findLoadedClass(String) is reachable: The declaring class of this element has been substituted, but this element is not present in the substitution class
...
Error: com.oracle.svm.hosted.substitute.DeletedElementException: Unsupported method java.lang.ClassLoader.loadClass(String, boolean) is reachable: The declaring class of this element has been substituted, but this element is not present in the substitution class
To diagnose the issue, you can add the option --report-unsupported-elements-at-runtime. The unsupported element is then reported at run time when it is accessed the first time.</code></pre></div></div><div class="paragraph"><p>Options <em class="conum" data-value="3"></em> and <em class="conum" data-value="4"></em> specify that all packages and classes are initialized during the native image generation, except for the two: <code>org.codehaus.groovy.control.XStreamUtils</code> and <code>groovy.grape.GrapeIvy</code>.</p></div><div class="paragraph"><p>With <code>--no-fallback</code> option <em class="conum" data-value="5"></em> we want to force the native image compiler that we expect the native image is either generated correctly, or the compilation fails. Without this option set, the compiler falls back to the regular JDK execution in case of an error faced during the compilation. When it happens, we see the following message in the console log.</p></div><div class="listingblock"><div class="title">Listing 13. Fallback strategy in case of an error during image compilation</div><div class="content"><pre class="highlightjs highlight"><code class="language-text hljs" data-lang="text">Warning: Image 'randomnumber' is a fallback image that requires a JDK for execution (use --no-fallback to suppress fallback image generation).</code></pre></div></div><div class="paragraph"><p>The <code>--no-server</code> option <em class="conum" data-value="6"></em> informs the compiler that we don&#8217;t want to use image-build server. We also set <em class="conum" data-value="7"></em> the same classpath we set when running Groovy as a Java program. And the last line <em class="conum" data-value="8"></em> contains the name of the <code>RandomNumber.class</code> file.</p></div><div class="paragraph"><p>The compilation takes approximately 60 seconds and this is the output we should expect.</p></div><div class="listingblock"><div class="title">Listing 14. The expected native image compilation console output</div><div class="content"><pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ native-image --allow-incomplete-classpath \
    --report-unsupported-elements-at-runtime \
    --initialize-at-build-time \
    --initialize-at-run-time=org.codehaus.groovy.control.XStreamUtils,groovy.grape.GrapeIvy \
    --no-fallback \
    --no-server \
    -cp ".:$GROOVY_HOME/lib/groovy-2.5.8.jar" \
    RandomNumber
[randomnumber:30836]    classlist:   2,543.84 ms
[randomnumber:30836]        (cap):     842.60 ms
[randomnumber:30836]        setup:   2,037.49 ms
[randomnumber:30836]   (typeflow):  10,398.18 ms
[randomnumber:30836]    (objects):  12,716.21 ms
[randomnumber:30836]   (features):     502.37 ms
[randomnumber:30836]     analysis:  24,049.68 ms
[randomnumber:30836]     (clinit):     309.26 ms
[randomnumber:30836]     universe:     952.52 ms
[randomnumber:30836]      (parse):   2,359.79 ms
[randomnumber:30836]     (inline):   3,216.99 ms
[randomnumber:30836]    (compile):  17,702.26 ms
[randomnumber:30836]      compile:  24,547.04 ms
[randomnumber:30836]        image:   2,308.60 ms
[randomnumber:30836]        write:     352.50 ms
[randomnumber:30836]      [total]:  56,941.42 ms</code></pre></div></div></div></div><div class="sect1"><h2 id="running-standalone-native-image">Running standalone native image</h2><div class="sectionbody"><div class="paragraph"><p>The compilation succeeds and we can see <code>randomnumber</code> executable file in the current folder.</p></div><div class="listingblock"><div class="title">Listing 15. The current folder with <code>randomnumber</code> executable file</div><div class="content"><pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ ls -lah randomnumber
-rwxrwxr-x 1 wololock wololock 21M 05-11 13:13 randomnumber</code></pre></div></div><div class="paragraph"><p>Let&#8217;s run it and see the result.</p></div><div class="listingblock"><div class="title">Listing 16. Running executable file for the first time</div><div class="content"><pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ ./randomnumber
The random number is: 397
Exception in thread "main" groovy.lang.MissingMethodException: No signature of method: RandomNumber$_main_closure1.doCall() is applicable for argument types: (Integer) values: [0]
Possible solutions: findAll(), findAll(), isCase(java.lang.Object), isCase(java.lang.Object)
	at org.codehaus.groovy.runtime.metaclass.ClosureMetaClass.invokeMethod(ClosureMetaClass.java:255)
	at groovy.lang.MetaClassImpl.invokeMethod(MetaClassImpl.java:1041)
	at groovy.lang.Closure.call(Closure.java:405)
	at org.codehaus.groovy.runtime.DefaultGroovyMethods.sum(DefaultGroovyMethods.java:6648)
	at org.codehaus.groovy.runtime.DefaultGroovyMethods.sum(DefaultGroovyMethods.java:6548)
	at RandomNumber.main(RandomNumber.groovy:7)</code></pre></div></div><div class="paragraph"><p>Something is broken. The first line <code>The random number is: 397</code> gets printed correctly, but it fails when trying to invoke <code>RandomNumber$_main_closure1.doCall(int)</code>. How is that?</p></div><div class="paragraph"><p>This method represents the closure we pass to the <code>(0..random).sum()</code> method. The problem is that the process of the <code>doCall(int)</code> method lookup uses reflection. And even though the native image supports runtime reflection<sup class="footnote">[<a id="_footnoteref_3" class="footnote" href="#_footnotedef_3" title="View footnote.">3</a>]</sup>, in some cases it is not able do determine it correctly, thus it requires additional configuration provided by the user.</p></div></div></div><div class="sect1"><h2 id="reflection-configuration">Reflection configuration</h2><div class="sectionbody"><div class="paragraph"><p>The manual reflection configuration for GraalVM native image is fairly simple<sup class="footnote">[<a id="_footnoteref_4" class="footnote" href="#_footnotedef_4" title="View footnote.">4</a>]</sup>. All we have to do is to create a JSON configuration file and add <code>-H:ReflectionConfigurationFiles=&#8230;&#8203;</code> to the command line. We can either configure class that will be used reflectively using helper options like <code>allDeclaredMethods</code>, or we can manually provide a list of methods (and their parameters) we expect to get invoked using reflection. To keep this example simple, we will use the first approach.</p></div><div class="listingblock"><div class="title">Listing 17. Our exemplary <code>reflections.json</code> file</div><div class="content"><pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">[
  {
    "name": "RandomNumber$_main_closure1",
    "allDeclaredConstructors": true,
    "allPublicConstructors": true,
    "allDeclaredMethods": true,
    "allPublicMethods": true
  }
]</code></pre></div></div><div class="paragraph"><p>Let&#8217;s recompile the native image using reflection configuration.</p></div><div class="listingblock"><div class="title">Listing 18. Recompiling native image using reflection configuration</div><div class="content"><pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ native-image --allow-incomplete-classpath \
    --report-unsupported-elements-at-runtime \
    --initialize-at-build-time \
    --initialize-at-run-time=org.codehaus.groovy.control.XStreamUtils,groovy.grape.GrapeIvy \
    --no-fallback \
    --no-server \
    -cp ".:$GROOVY_HOME/lib/groovy-2.5.7.jar" \
    <strong>-H:ReflectionConfigurationFiles=reflections.json</strong> \
    RandomNumber
[randomnumber:14904]    classlist:   2,465.48 ms
[randomnumber:14904]        (cap):     847.33 ms
[randomnumber:14904]        setup:   1,956.50 ms
[randomnumber:14904]   (typeflow):  10,908.61 ms
[randomnumber:14904]    (objects):  14,070.69 ms
[randomnumber:14904]   (features):     389.80 ms
[randomnumber:14904]     analysis:  26,006.96 ms
[randomnumber:14904]     (clinit):     368.34 ms
[randomnumber:14904]     universe:   1,018.86 ms
[randomnumber:14904]      (parse):   2,536.26 ms
[randomnumber:14904]     (inline):   3,122.56 ms
[randomnumber:14904]    (compile):  18,851.47 ms
[randomnumber:14904]      compile:  25,996.75 ms
[randomnumber:14904]        image:   2,547.31 ms
[randomnumber:14904]        write:     375.97 ms
[randomnumber:14904]      [total]:  60,535.87 ms</code></pre></div></div><div class="paragraph"><p>We can run the program again to see if it works.</p></div><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ ./randomnumber
The random number is: 869
java.lang.ClassNotFoundException: org.codehaus.groovy.runtime.dgm$521
	at com.oracle.svm.core.hub.ClassForNameSupport.forName(ClassForNameSupport.java:51)
	at java.lang.ClassLoader.loadClass(Target_java_lang_ClassLoader.java:131)
	at org.codehaus.groovy.reflection.GeneratedMetaMethod$Proxy.createProxy(GeneratedMetaMethod.java:101)
	at org.codehaus.groovy.reflection.GeneratedMetaMethod$Proxy.proxy(GeneratedMetaMethod.java:93)
	at org.codehaus.groovy.reflection.GeneratedMetaMethod$Proxy.isValidMethod(GeneratedMetaMethod.java:78)
	at groovy.lang.MetaClassImpl.chooseMethodInternal(MetaClassImpl.java:3226)
	at groovy.lang.MetaClassImpl.chooseMethod(MetaClassImpl.java:3188)
	at groovy.lang.MetaClassImpl.getNormalMethodWithCaching(MetaClassImpl.java:1399)
	at groovy.lang.MetaClassImpl.getMethodWithCaching(MetaClassImpl.java:1314)
	at groovy.lang.MetaClassImpl.getMetaMethod(MetaClassImpl.java:1229)
	at groovy.lang.MetaClassImpl.invokeMethod(MetaClassImpl.java:1082)
	at groovy.lang.MetaClassImpl.invokeMethod(MetaClassImpl.java:1041)
	at org.codehaus.groovy.runtime.DefaultGroovyMethods.sum(DefaultGroovyMethods.java:6655)
	at org.codehaus.groovy.runtime.DefaultGroovyMethods.sum(DefaultGroovyMethods.java:6548)
	at RandomNumber.main(RandomNumber.groovy:7)
Exception in thread "main" groovy.lang.GroovyRuntimeException: Failed to create DGM method proxy : java.lang.ClassNotFoundException: org.codehaus.groovy.runtime.dgm$521
	at org.codehaus.groovy.reflection.GeneratedMetaMethod$Proxy.createProxy(GeneratedMetaMethod.java:106)
	at org.codehaus.groovy.reflection.GeneratedMetaMethod$Proxy.proxy(GeneratedMetaMethod.java:93)
	at org.codehaus.groovy.reflection.GeneratedMetaMethod$Proxy.isValidMethod(GeneratedMetaMethod.java:78)
	at groovy.lang.MetaClassImpl.chooseMethodInternal(MetaClassImpl.java:3226)
	at groovy.lang.MetaClassImpl.chooseMethod(MetaClassImpl.java:3188)
	at groovy.lang.MetaClassImpl.getNormalMethodWithCaching(MetaClassImpl.java:1399)
	at groovy.lang.MetaClassImpl.getMethodWithCaching(MetaClassImpl.java:1314)
	at groovy.lang.MetaClassImpl.getMetaMethod(MetaClassImpl.java:1229)
	at groovy.lang.MetaClassImpl.invokeMethod(MetaClassImpl.java:1082)
	at groovy.lang.MetaClassImpl.invokeMethod(MetaClassImpl.java:1041)
	at org.codehaus.groovy.runtime.DefaultGroovyMethods.sum(DefaultGroovyMethods.java:6655)
	at org.codehaus.groovy.runtime.DefaultGroovyMethods.sum(DefaultGroovyMethods.java:6548)
	at RandomNumber.main(RandomNumber.groovy:7)
Caused by: java.lang.ClassNotFoundException: org.codehaus.groovy.runtime.dgm$521
	at com.oracle.svm.core.hub.ClassForNameSupport.forName(ClassForNameSupport.java:51)
	at java.lang.ClassLoader.loadClass(Target_java_lang_ClassLoader.java:131)
	at org.codehaus.groovy.reflection.GeneratedMetaMethod$Proxy.createProxy(GeneratedMetaMethod.java:101)
	... 12 more</code></pre></div></div><div class="paragraph"><p>Failed again. This time it couldn&#8217;t find a class <code>org.codehaus.groovy.runtime.dgm$521</code>. This is one of the classes that represent Groovy dynamic methods - methods that extend e.g. JDK classes with the new methods. This class is also accessed through reflection, let&#8217;s add to our <code>reflection.json</code> configuration file.</p></div><div class="listingblock"><div class="title">Listing 19. Updated <code>reflections.json</code> file</div><div class="content"><pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">[
  {
    "name": "RandomNumber$_main_closure1",
    "allDeclaredConstructors": true,
    "allPublicConstructors": true,
    "allDeclaredMethods": true,
    "allPublicMethods": true
  },
  <strong>{
    "name": "org.codehaus.groovy.runtime.dgm$521",
    "allDeclaredConstructors": true,
    "allPublicConstructors": true,
    "allDeclaredMethods": true,
    "allPublicMethods": true
  }</strong>
]</code></pre></div></div><div class="paragraph"><p>Let&#8217;s recompile the native image using the same command as before. When the compilation is done, let&#8217;s see if it works.</p></div><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ ./randomnumber
The random number is: 853
java.lang.ClassNotFoundException: org.codehaus.groovy.runtime.dgm$1180
	at com.oracle.svm.core.hub.ClassForNameSupport.forName(ClassForNameSupport.java:51)
	at java.lang.ClassLoader.loadClass(Target_java_lang_ClassLoader.java:131)
	at org.codehaus.groovy.reflection.GeneratedMetaMethod$Proxy.createProxy(GeneratedMetaMethod.java:101)
	at org.codehaus.groovy.reflection.GeneratedMetaMethod$Proxy.proxy(GeneratedMetaMethod.java:93)
	at org.codehaus.groovy.reflection.GeneratedMetaMethod$Proxy.isValidMethod(GeneratedMetaMethod.java:78)
	at groovy.lang.MetaClassImpl.chooseMethodInternal(MetaClassImpl.java:3226)
	at groovy.lang.MetaClassImpl.chooseMethod(MetaClassImpl.java:3188)
	at groovy.lang.MetaClassImpl.getNormalMethodWithCaching(MetaClassImpl.java:1399)
	at groovy.lang.MetaClassImpl.getMethodWithCaching(MetaClassImpl.java:1314)
	at groovy.lang.MetaClassImpl.getMetaMethod(MetaClassImpl.java:1229)
	at groovy.lang.MetaClassImpl.invokeMethod(MetaClassImpl.java:1082)
	at groovy.lang.MetaClassImpl.invokeMethod(MetaClassImpl.java:1041)
	at org.codehaus.groovy.runtime.DefaultGroovyMethods.sum(DefaultGroovyMethods.java:6655)
	at org.codehaus.groovy.runtime.DefaultGroovyMethods.sum(DefaultGroovyMethods.java:6548)
	at RandomNumber.main(RandomNumber.groovy:7)
Exception in thread "main" groovy.lang.GroovyRuntimeException: Failed to create DGM method proxy : java.lang.ClassNotFoundException: org.codehaus.groovy.runtime.dgm$1180
	at org.codehaus.groovy.reflection.GeneratedMetaMethod$Proxy.createProxy(GeneratedMetaMethod.java:106)
	at org.codehaus.groovy.reflection.GeneratedMetaMethod$Proxy.proxy(GeneratedMetaMethod.java:93)
	at org.codehaus.groovy.reflection.GeneratedMetaMethod$Proxy.isValidMethod(GeneratedMetaMethod.java:78)
	at groovy.lang.MetaClassImpl.chooseMethodInternal(MetaClassImpl.java:3226)
	at groovy.lang.MetaClassImpl.chooseMethod(MetaClassImpl.java:3188)
	at groovy.lang.MetaClassImpl.getNormalMethodWithCaching(MetaClassImpl.java:1399)
	at groovy.lang.MetaClassImpl.getMethodWithCaching(MetaClassImpl.java:1314)
	at groovy.lang.MetaClassImpl.getMetaMethod(MetaClassImpl.java:1229)
	at groovy.lang.MetaClassImpl.invokeMethod(MetaClassImpl.java:1082)
	at groovy.lang.MetaClassImpl.invokeMethod(MetaClassImpl.java:1041)
	at org.codehaus.groovy.runtime.DefaultGroovyMethods.sum(DefaultGroovyMethods.java:6655)
	at org.codehaus.groovy.runtime.DefaultGroovyMethods.sum(DefaultGroovyMethods.java:6548)
	at RandomNumber.main(RandomNumber.groovy:7)
Caused by: java.lang.ClassNotFoundException: org.codehaus.groovy.runtime.dgm$1180
	at com.oracle.svm.core.hub.ClassForNameSupport.forName(ClassForNameSupport.java:51)
	at java.lang.ClassLoader.loadClass(Target_java_lang_ClassLoader.java:131)
	at org.codehaus.groovy.reflection.GeneratedMetaMethod$Proxy.createProxy(GeneratedMetaMethod.java:101)
	... 12 more</code></pre></div></div><div class="paragraph"><p>Failed again. This time the class <code>org.codehaus.groovy.runtime.dgm$1180</code> cannot be found. Let&#8217;s add it to the <code>reflections.json</code> configuration file.</p></div><div class="listingblock"><div class="title">Listing 20. Another update to <code>reflections.json</code> file</div><div class="content"><pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">[
  {
    "name": "RandomNumber$_main_closure1",
    "allDeclaredConstructors": true,
    "allPublicConstructors": true,
    "allDeclaredMethods": true,
    "allPublicMethods": true
  },
  {
    "name": "org.codehaus.groovy.runtime.dgm$521",
    "allDeclaredConstructors": true,
    "allPublicConstructors": true,
    "allDeclaredMethods": true,
    "allPublicMethods": true
  },
  <strong>{
    "name": "org.codehaus.groovy.runtime.dgm$1180",
    "allDeclaredConstructors": true,
    "allPublicConstructors": true,
    "allDeclaredMethods": true,
    "allPublicMethods": true
  }</strong>
]</code></pre></div></div><div class="paragraph"><p>After updating the configuration file, let&#8217;s recompile the image using the same command as before. When it&#8217;s done, it&#8217;s time to run the program.</p></div><div class="listingblock"><div class="title">Listing 21. Working native image</div><div class="content"><pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ ./randomnumber
The random number is: 859
The doubled sum of numbers between 0 and 859 is 738740</code></pre></div></div><div class="paragraph"><p><strong>It worked!</strong> You also noticed that the reaction time is much better compared to the previous attempts (running Groovy code as a Java program). Let&#8217;s measure native image execution time.</p></div><div class="listingblock"><div class="title">Listing 22. The native image execution time</div><div class="content"><pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">time ./randomnumber
The random number is: 580
The doubled sum of numbers between 0 and 580 is 336980

real	0m0,008s
user	0m0,005s
sys	0m0,003s</code></pre></div></div><div class="paragraph"><p>This is really nice - <strong>8 ms</strong>. And here is how does it look like compared to the previous results.</p></div><div class="openblock text-center"><div class="content"><div class="imageblock img-responsive img-thumbnail"><div class="content"><a class="image" href="/images/graalvm-groovy-execution-time.png"><div class="img-lazyload-container" style="width:977px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==);background-repeat:no-repeat;background-position:center"><img data-original="/images/graalvm-groovy-execution-time.png" height="368" width="977" style="padding-top:37.66632548618219%"></div></a></div></div></div></div><div class="paragraph"><p>As you can see, GraalVM&#8217;s native image outperforms the two previous attempts.</p></div></div></div><div class="sect1"><h2 id="automated-reflection-configuration">Automated reflection configuration</h2><div class="sectionbody"><div class="paragraph"><p>I guess we both agree, that this manual reflection configuration was pretty annoying. We added a class to a configuration, then we recompiled the native image just to get another exception with a different missing class. In case of a such simple program we had to add three classes to the reflection configuration. We can imagine how ineffective would it be in case of a much more complex example.</p></div><div class="paragraph"><p>Luckily, there is a solution to this problem. GraalVM&#8217;s JDK is distributed with <code>native-image-agent</code> - a Java agent that can be used to run our program with GraalVM&#8217;s JDK that introspects the code usage. It can detect all reflection for us (and not only that).</p></div><div class="paragraph"><p>Let&#8217;s give it a try. Firstly, we need to run our compiled Groovy code as a Java program with the <code>native-image-agent</code> enabled.</p></div><div class="listingblock"><div class="title">Listing 23. Running as a Java program with the agent enabled</div><div class="content"><pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ java -agentlib:native-image-agent=config-output-dir=conf/ \<i class="conum" data-value="1"></i><b>(1)</b>
    -cp ".:$GROOVY_HOME/lib/groovy-2.5.8.jar" RandomNumber</code></pre></div></div><div class="paragraph"><p>The program executes like it did before, but know it created 4 configuration files in the folder we specified with <em class="conum" data-value="1"></em> parameter (in this case I used <code>conf/</code> folder). Here are the files that got created.</p></div><div class="listingblock"><div class="title">Listing 24. Automatically generated configuration files for the native image builder</div><div class="content"><pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ tree conf
<strong>conf</strong>
├── jni-config.json
├── proxy-config.json
├── reflect-config.json
└── resource-config.json

0 directories, 4 files</code></pre></div></div><div class="paragraph"><p>If you open <code>conf/reflect-config.json</code> file you will see that it contains tons of classes configured for the reflective access. (In my case this file is 579 lines long.)</p></div><div class="paragraph"><p>The last thing we have to do is to remove <code>-H:ReflectionConfigurationFiles</code> parameters and use the <code>-H:ConfigurationFileDirectories</code> parameter instead. It loads not only reflection configuration files, but also remaining three configurations for proxies, JNI, and resources.</p></div><div class="listingblock"><div class="title">Listing 25. Using automatically generated reflection configuration file</div><div class="content"><pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ native-image --allow-incomplete-classpath \
    --report-unsupported-elements-at-runtime \
    --initialize-at-build-time \
    --initialize-at-run-time=org.codehaus.groovy.control.XStreamUtils,groovy.grape.GrapeIvy \
    --no-fallback \
    --no-server \
    -cp ".:$GROOVY_HOME/lib/groovy-2.5.7.jar" \
    <strong>-H:ConfigurationFileDirectories=conf/</strong> \
    RandomNumber</code></pre></div></div><div class="paragraph"><p>It compiles in 70 seconds.</p></div><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">[randomnumber:6854]    classlist:   2,495.24 ms
[randomnumber:6854]        (cap):     924.98 ms
[randomnumber:6854]        setup:   2,170.19 ms
[randomnumber:6854]   (typeflow):  12,968.96 ms
[randomnumber:6854]    (objects):  17,112.64 ms
[randomnumber:6854]   (features):     568.95 ms
[randomnumber:6854]     analysis:  31,241.39 ms
[randomnumber:6854]     (clinit):     447.44 ms
[randomnumber:6854]     universe:   1,339.22 ms
[randomnumber:6854]      (parse):   2,724.16 ms
[randomnumber:6854]     (inline):   4,752.75 ms
[randomnumber:6854]    (compile):  20,960.41 ms
[randomnumber:6854]      compile:  29,926.05 ms
[randomnumber:6854]        image:   2,818.74 ms
[randomnumber:6854]        write:     373.36 ms
[randomnumber:6854]      [total]:  70,552.29 ms</code></pre></div></div><div class="paragraph"><p>And see if it works with those automatically generated configuration files.</p></div><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ ./randomnumber
The random number is: 347
The doubled sum of numbers between 0 and 347 is 120756</code></pre></div></div><div class="paragraph"><p>Cowabunga! No problems this time! <span class="icon"><i class="fa fa-smile-o"></i></span></p></div></div></div><div class="sect1"><h2 id="limitations">Limitations</h2><div class="sectionbody"><div class="paragraph"><p>Even though we compiled the native image successfully, we need to be aware of a few significant limitations. Groovy is not a first class citizen for GraalVM&#8217;s ahead-of-time compilation by design, and that is why you can&#8217;t expect that your Groovy program will compile to the native image successfully. Below is the list of the major limitations that cannot be avoided.</p></div><div class="ulist"><ul><li><p>GraalVM&#8217;s SubstrateVM does not support <strong>dynamic class loading</strong>, <strong>dynamic class generation</strong>, and <strong>bytecode InvokeDynamic</strong>. This limitation makes dynamic Groovy scripts and classes almost 99% incompatible with building native images. That is why we had to turn on static compilation in the example described above.</p></li></ul></div><div class="admonitionblock note"><table><tr><td class="icon"><i class="fa icon-note" title="Note"></i></td><td class="content">Here you can read more about <a href="https://github.com/oracle/graal/blob/master/substratevm/LIMITATIONS.md" target="_blank" rel="noopener">SubstrateVM limitations</a>.</td></tr></table></div><div class="ulist"><ul><li><p>Metaprogramming features don&#8217;t work in the native image.</p></li><li><p>Coercing closures to other specific types (e.g. functional interfaces used with Java 8 Stream API) does not work.</p></li></ul></div></div></div><div class="sect1"><h2 id="conclusion">Conclusion</h2><div class="sectionbody"><div class="paragraph"><p>I hope you have learned something interesting from this blog post. If you are interested in learning more about Groovy and GraalVM, checkout my other blog posts you can find in the section below.</p></div><div class="paragraph"><p>You can also check my <a href="https://github.com/wololock/graalvm-groovy-examples" target="_blank" rel="noopener">wololock/graalvm-groovy-examples</a> GitHub repository, where I collect some of the demos and examples I create during my experiments. Feel free to test it, experiment on your side and contribute to the project. GraalVM is fascinating and quite challenging piece of technology. The more we experiment with it and learn how to use it most effectively, the more we can help other people adopting it.</p></div><div class="video-container"><iframe width="560" height="315" src="https://www.youtube.com/embed/BjO_vBzaB4c" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></div></div></div><div class="sect1"><h2 id="useful-resources">Useful resources</h2><div class="sectionbody"><div class="paragraph"><p>Here you can find a list of blog posts I found useful when I was working on this article.</p></div><div class="ulist"><ul><li><p><a href="https://github.com/wololock/groovy-and-graalvm" target="_blank" rel="noopener"><em>Source code from my "GraalVM adn Groovy" presentation from GR8Conf EU 2019</em></a></p></li><li><p><a href="https://github.com/graemerocher/micronaut-graal-experiments" target="_blank" rel="noopener"><em>Micronaut Graal Experiments</em></a> by <a href="https://twitter.com/graemerocher" target="_blank" rel="noopener">Graeme Rocher</a></p></li><li><p><a href="https://medium.com/graalvm/instant-netty-startup-using-graalvm-native-image-generation-ed6f14ff7692" target="_blank" rel="noopener"><em>Instant Netty Startup using GraalVM Native Image Generation</em></a> by <a href="https://twitter.com/cstancu" target="_blank" rel="noopener">Codruț Stancu</a></p></li><li><p><a href="https://blog.frankel.ch/first-impressions-graalvm/" target="_blank" rel="noopener"><em>My first impressions about Graal VM</em></a> by <a href="https://twitter.com/nicolas_frankel" target="_blank" rel="noopener">Nicolas Frankel</a></p></li><li><p><a href="https://melix.github.io/blog/2019/03/simple-http-server-graal.html" target="_blank" rel="noopener"><em>A simple native HTTP server with GraalVM</em></a> by <a href="https://twitter.com/CedricChampeau" target="_blank" rel="noopener">Cédric Champeau</a></p></li></ul></div></div></div><div class="sect1"><h2 id="updates">Updates</h2><div class="sectionbody"><div class="paragraph"><p>This blog gets updated whenever new version of GraalVM or Groovy gets released. Below you can find a list of all updates.</p></div><div class="ulist"><ul><li><p><strong class="mark">2019-11-22</strong>: Added information about problems with <strong>GraalVM</strong> <code>19.3.0</code> native image compiler.</p></li><li><p><strong class="mark">2019-11-07</strong>: Updated blog post to <strong>GraalVM</strong> <code>19.2.1</code> and <strong>Groovy</strong> <code>2.5.8</code>.</p></li><li><p><strong class="mark">2019-05-11</strong>: Updated blog post to <strong>GraalVM</strong> <code>19.0.0</code>.</p></li></ul></div><div class="row"><div class="col-12"><script async data-uid="5e86560171" src="https://tremendous-motivator-1432.ck.page/5e86560171/index.js"></script></div></div><h2 id="thank-you" class="discrete">Thank you!</h2><div class="paragraph"><p>If you read up to this point - leave me a comment below, so I can <strong>thank you</strong> in person for such an engagement. You can also share this blog post on <span class="icon color-twitter"><i class="fa fa-twitter"></i></span> <a href="https://twitter.com/intent/tweet?text=%22GraalVM%20and%20Groovy%20-%20how%20to%20start?%22%20https://e.printstacktrace.blog/graalvm-and-groovy-how-to-start/%20via%20@wololock" target="_blank" rel="noopener">Twitter</a>, <span class="icon color-facebook"><i class="fa fa-facebook-square"></i></span> <a href="https://www.facebook.com/sharer/sharer.php?u=https://e.printstacktrace.blog/graalvm-and-groovy-how-to-start/&t=GraalVM%20and%20Groovy%20-%20how%20to%20start?" target="_blank" rel="noopener">Facebook</a>, or <span class="icon color-linkedin"><i class="fa fa-linkedin-square"></i></span> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https://e.printstacktrace.blog/graalvm-and-groovy-how-to-start/&title=GraalVM%20and%20Groovy%20-%20how%20to%20start?" target="_blank" rel="noopener">LinkedIn</a> if you think other people can benefit from reading it. Thanks in advance!</p></div><div class="paragraph"><p>PS: Creating high-quality content takes a lot of time and effort. I want to deliver the best possible value to my readers and keep the blog always <strong>ad-free</strong>. If you have two more minutes, please take a look at this dedicated page where I listed a few different options to <a href="https://e.printstacktrace.blog/support-me" class="ga-track">support my efforts</a>. If my vision for the <em>e.printstacktrace.blog</em> development resonates with you, I will be grateful if you consider supporting me in this journey. <strong>Thank you! <span class="icon color-red"><i class="fa fa-heart"></i></span></strong></p></div></div></div><div id="footnotes"><hr><div class="footnote" id="_footnotedef_1"><a href="#_footnoteref_1">1</a>. <a href="https://www.graalvm.org/docs/release-notes/19_3/#native-image" target="_blank" rel="noopener" class="bare">https://www.graalvm.org/docs/release-notes/19_3/#native-image</a></div><div class="footnote" id="_footnotedef_2"><a href="#_footnoteref_2">2</a>. As explained by Condrut Stancu in the following Github issue comment <a href="https://github.com/oracle/graal/issues/346#issuecomment-383015796" target="_blank" rel="noopener" class="bare">https://github.com/oracle/graal/issues/346#issuecomment-383015796</a></div><div class="footnote" id="_footnotedef_3"><a href="#_footnoteref_3">3</a>. You can read more about it here <a href="https://github.com/oracle/graal/blob/master/substratevm/LIMITATIONS.md#reflection" target="_blank" rel="noopener" class="bare">https://github.com/oracle/graal/blob/master/substratevm/LIMITATIONS.md#reflection</a></div><div class="footnote" id="_footnotedef_4"><a href="#_footnoteref_4">4</a>. The manual reflection configuration is described here <a href="https://github.com/oracle/graal/blob/master/substratevm/REFLECTION.md#manual-configuration" target="_blank" rel="noopener" class="bare">https://github.com/oracle/graal/blob/master/substratevm/REFLECTION.md#manual-configuration</a></div></div><footer class="post-footer"><img class="img-responsive img-circle" src="https://www.gravatar.com/avatar/b22c1842c6e8f7f2b9b3ed8c0d4efb4d?s=200"><div class="row author"><div class="col-lg-8 col-lg-offset-2 col-xs-10 col-xs-offset-1"><h4>Szymon Stepniak</h4><p><a class="stack-overflow" href="https://stackoverflow.com/users/2194470/szymon-stepniak?tab=profile" target="_blank" rel="noopener"><img class="so-icon" src="/img/so.png"><b class="rep">27,343</b><span class="badges"><span class="gold"><span class="b">●</span><span class="c">9</span></span><span class="silver"><span class="b">●</span><span class="c">61</span></span><span class="bronze"><span class="b">●</span><span class="c">94</span></span></span></a></p><p>Groovista, Upwork's Top Rated freelancer, Toruń Java User Group founder, open&nbsp;source contributor, Stack Overflow addict, bedroom guitar player. I walk through e.printStackTrace() so you don't have to.</p><ul class="social-links"><li><a href="https://feeds.feedburner.com/Eprintstacktracenet" target="_blank" rel="noopener" onclick="return window.open(this.href),!1"><span class="fa fa-rss"></span></a></li><li><a href="https://twitter.com/wololock" target="_blank" rel="noopener" onclick="return window.open(this.href),!1"><span class="fa fa-twitter"></span></a></li><li><a href="https://github.com/wololock" target="_blank" rel="noopener" onclick="return window.open(this.href),!1"><span class="fa fa-github"></span></a></li><li><a href="https://stackoverflow.com/users/2194470/szymon-stepniak?tab=profile" target="_blank" rel="noopener" onclick="return window.open(this.href),!1"><span class="fa fa-stack-overflow"></span></a></li><li><a href="https://www.youtube.com/c/eprintstacktrace" target="_blank" rel="noopener" onclick="return window.open(this.href),!1"><span class="fa fa-youtube"></span></a></li><li><a href="mailto:szymon.stepniak@gmail.com" onclick="return window.open(this.href),!1"><span class="fa fa-envelope"></span></a></li><li><a href="https://www.linkedin.com/in/szymon-stępniak-9a0b1630" target="_blank" rel="noopener" onclick="return window.open(this.href),!1"><span class="fa fa-linkedin"></span></a></li><li><a href="https://keybase.io/wololock" target="_blank" rel="noopener" onclick="return window.open(this.href),!1"><span class="fa fa-user-secret"></span></a></li></ul></div></div></footer><section class="related-posts"><h2>You may also like</h2><div class="row"><div class="col-lg-4"><a href="/graalvm-native-image-inside-docker-container-does-it-make-sense/"><img class="img-responsive" src="/images/og/graalvm-docker-groovy.jpg"><h3>GraalVM native image inside docker container - does it make sense?</h3></a><p>We have learned how to create GraalVM native image from standalone Groovy script in the previous blog post. Today we continue the experiments, and this time we are going to create a Docker image to...</p></div><div class="col-lg-4"><a href="/ratpack-graalvm-how-to-start/"><img class="img-responsive" src="/images/og/ratpack-graalvm-how-to-start.jpg"><h3>Ratpack on GraalVM - how to start?</h3></a><p>The journey inside the exciting world of GraalVM continues. Today I would like to share with you results of running Ratpack on GraalVM experiment. You are going to learn how to build a native binar...</p></div><div class="col-lg-4"><a href="/graalvm-groovy-grape-creating-native-image-of-standalone-script/"><img class="img-responsive" src="/images/og/graalvm-groovy-grape.jpg"><h3>GraalVM with Groovy and Grape - creating native image of a standalone script</h3></a><p>The Apache Groovy programming language has extraordinary scripting capabilities. When you combine it with the Grape dependency management system, it turns out that the sky is the limit. In one of t...</p></div></div></section></article><nav class="pagination" role="pagination"><a class="pull-left btn" href="/how-to-avoid-no-tests-were-found-when-using-junit5-with-groovy/">← Next post</a><a class="pull-right btn" href="/what-is-the-most-efficient-way-to-iterate-collection-in-groovy-jmh/">Previous post →</a></nav><div class="disqus-comments"><div class="comments"><div id="disqus_thread"><div id="disqus_empty" style="display:none">Empty</div></div></div></div><script>function load_disqus(e){var t=document.getElementById("disqus_empty");if(document.contains(t)){var n=document.getElementById("disqus_thread"),d=document.createElement("script"),s=document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0];n&&t&&(t.remove(),d.type="text/javascript",d.async=!0,d.src="//"+e+".disqus.com/embed.js",s.appendChild(d))}}window.addEventListener("scroll",function(e){document.scrollingElement.scrollTop>document.getElementById("disqus_thread").getBoundingClientRect().top+350&&load_disqus("eprintstacktrace")},!1)</script></div></div></div><script async id="dsq-count-scr" src="//eprintstacktrace.disqus.com/count.js"></script><footer class="site-footer"><div class="container-fluid"><div class="row"><div class="col-lg-10 col-lg-offset-1 col-xs-10 col-xs-offset-1"><div class="row"><div class="col-lg-4"><h4 class="marked">Recent video on YouTube</h4><section class="recent-posts"><a href="https://www.youtube.com/watch?v=vJgcsyLJf0g" target="_blank" rel="noopener"><img class="img-thumbnail img-noborder" src="https://i3.ytimg.com/vi/vJgcsyLJf0g/mqdefault.jpg" alt="Brainf**k interpreter in Groovy (tail recursive implementation) | #groovylang"></a></section><h4>e.printstacktrace.blog © 2020</h4><p><em>"I walk through e.printStackTrace() so you don't have to"</em></p></div><div class="col-lg-4"><h4 class="marked">Recent articles</h4><section class="recent-posts"><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/how-to-time-out-jenkins-pipeline-stage-and-keep-the-pipeline-running/">How to time out Jenkins Pipeline stage and keep the pipeline running?</a></li><li class="post-list-item"><a class="post-list-link" href="/my-first-200-youtube-subscribers-thank-you/">My first 200 YouTube subscribers - Thank You!</a></li><li class="post-list-item"><a class="post-list-link" href="/groovy-dynamic-maps-generic-type-erasure-and-raw-types/">Groovy dynamic Maps, generic type erasure, and raw types - an interesting use case to learn from</a></li><li class="post-list-item"><a class="post-list-link" href="/groovy-3-nullcheck-annotation-less-code-and-less-npe/">Groovy 3 @NullCheck annotation - less code and less NPE</a></li><li class="post-list-item"><a class="post-list-link" href="/groovy-3-string-gdk-improvements-takeright-takebetween-and-a-few-others/">Groovy 3 String GDK improvements - takeRight, takeBetween, and a few others</a></li><li class="post-list-item"><a class="post-list-link" href="/jenkins-scripted-pipeline-vs-declarative-pipeline-the-4-practical-differences/">Jenkins Scripted Pipeline vs. Declarative Pipeline - the 4 practical differences</a></li></ul></section></div><div class="col-lg-4"><h4 class="marked">Stay connected</h4><div class="social-links"><ul><li><a href="https://feeds.feedburner.com/Eprintstacktracenet" target="_blank" rel="noopener" onclick="return window.open(this.href),!1"><span class="fa fa-rss"></span></a></li><li><a href="https://twitter.com/wololock" target="_blank" rel="noopener" onclick="return window.open(this.href),!1"><span class="fa fa-twitter"></span></a></li><li><a href="https://github.com/wololock" target="_blank" rel="noopener" onclick="return window.open(this.href),!1"><span class="fa fa-github"></span></a></li><li><a href="https://stackoverflow.com/users/2194470/szymon-stepniak?tab=profile" target="_blank" rel="noopener" onclick="return window.open(this.href),!1"><span class="fa fa-stack-overflow"></span></a></li><li><a href="https://www.youtube.com/c/eprintstacktrace" target="_blank" rel="noopener" onclick="return window.open(this.href),!1"><span class="fa fa-youtube"></span></a></li><li><a href="mailto:szymon.stepniak@gmail.com" onclick="return window.open(this.href),!1"><span class="fa fa-envelope"></span></a></li><li><a href="https://www.linkedin.com/in/szymon-stępniak-9a0b1630" target="_blank" rel="noopener" onclick="return window.open(this.href),!1"><span class="fa fa-linkedin"></span></a></li><li><a href="https://keybase.io/wololock" target="_blank" rel="noopener" onclick="return window.open(this.href),!1"><span class="fa fa-user-secret"></span></a></li></ul></div><h4 class="marked">Most popular tags</h4><section class="tagcloud"><a href="/t/affiliate/" style="font-size:12pt;color:#777">affiliate</a> <a href="/t/async/" style="font-size:8pt;color:#6a6a6a">async</a> <a href="/t/benchmark/" style="font-size:12pt;color:#777">benchmark</a> <a href="/t/book/" style="font-size:16pt;color:#858585">book</a> <a href="/t/cicd/" style="font-size:24pt;color:#9f9f9f">cicd</a> <a href="/t/devops/" style="font-size:12pt;color:#777">devops</a> <a href="/t/docker/" style="font-size:12pt;color:#777">docker</a> <a href="/t/graalvm/" style="font-size:24pt;color:#9f9f9f">graalvm</a> <a href="/t/groovy/" style="font-size:32pt;color:#bababa">groovy</a> <a href="/t/java/" style="font-size:28pt;color:#adadad">java</a> <a href="/t/java-8/" style="font-size:8pt;color:#6a6a6a">java-8</a> <a href="/t/jenkins/" style="font-size:20pt;color:#929292">jenkins</a> <a href="/t/jenkins-pipeline/" style="font-size:20pt;color:#929292">jenkins-pipeline</a> <a href="/t/jmh/" style="font-size:16pt;color:#858585">jmh</a> <a href="/t/maven/" style="font-size:8pt;color:#6a6a6a">maven</a> <a href="/t/micronaut/" style="font-size:12pt;color:#777">micronaut</a> <a href="/t/native-image/" style="font-size:12pt;color:#777">native-image</a> <a href="/t/non-blocking/" style="font-size:12pt;color:#777">non-blocking</a> <a href="/t/ratpack/" style="font-size:24pt;color:#9f9f9f">ratpack</a> <a href="/t/reactive-programming/" style="font-size:8pt;color:#6a6a6a">reactive-programming</a> <a href="/t/review/" style="font-size:16pt;color:#858585">review</a> <a href="/t/rxjava/" style="font-size:8pt;color:#6a6a6a">rxjava</a> <a href="/t/sdkman/" style="font-size:12pt;color:#777">sdkman</a> <a href="/t/spock/" style="font-size:12pt;color:#777">spock</a> <a href="/t/unit-test/" style="font-size:12pt;color:#777">unit-test</a></section></div></div></div></div><div class="row"><div class="col-lg-10 col-lg-offset-1 col-xs-10 col-xs-offset-1 text-center"><ul class="footer-links"><li><a href="/privacy-policy/">Privacy policy</a></li><li><a href="/support-me/">Support me</a></li><li><a href="http://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener"><img src="https://badgen.net/badge/license/CC%20BY-NC-SA%204.0/gray"></a></li><li><a href="https://github.com/wololock/wololock.github.io/commits/develop" target="_blank" rel="noopener"><img src="https://badgen.net/github/last-commit/wololock/wololock.github.io?color=blue"></a></li></ul></div></div></div><section class="poweredby"><ul class="text-center"><li><span>Published with </span><a href="https://hexo.io" target="_blank" rel="noopener" onclick="return window.open(this.href),!1"><img src="/img/logo-hexo.png"></a></li><li><span>Hosted on </span><a href="https://github.com/wololock/wololock.github.io" target="_blank" rel="noopener" onclick="return window.open(this.href),!1"><img src="/img/logo-github.png"></a></li><li><span>Deployed with </span><a href="https://circleci.com/gh/wololock/wololock.github.io" target="_blank" rel="noopener" onclick="return window.open(this.href),!1"><img src="/img/logo-circleci.png"></a></li></ul></section></footer><script src="//cdnjs.cloudflare.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script><script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script><script async id="cookiebanner" src="//cdnjs.cloudflare.com/ajax/libs/cookie-banner/1.2.2/cookiebanner.min.js" data-moreinfo="/privacy-policy/" data-message="This blog uses cookies to enhance your experience. By continuing to visit it you agree to its use of cookies." data-link="#ffad33" data-font-family="Lora,serif" data-font-size="1.6rem" data-bg="#444"></script><script src="/js/main.js?v=5"></script><script src="/js/highlight.pack.js?v=9.18.1"></script><script>hljs.initHighlightingOnLoad()</script><script>"localhost"!==window.location.hostname&&"127.0.0.1"!==window.location.hostname&&(!function(a,e,t,n,o,c,i){a.GoogleAnalyticsObject=o,a.ga=a.ga||function(){(a.ga.q=a.ga.q||[]).push(arguments)},a.ga.l=1*new Date,c=e.createElement(t),i=e.getElementsByTagName(t)[0],c.async=1,c.src="//www.google-analytics.com/analytics.js",i.parentNode.insertBefore(c,i)}(window,document,"script",0,"ga"),ga("create","UA-42400890-5","auto"),ga("send","pageview"),jQuery("a.ga-track").click(function(a){var e=jQuery(a.target).text();return ga("send","event","affiliate","click",e),!0}))</script><script>!function(){"use strict";function r(e){var t=e.getAttribute("data-original"),n=new Image;n.onload=function(){e.setAttribute("src",t),e.style.paddingTop=""},n.src=t}document.addEventListener("DOMContentLoaded",function(){var t,e,n,i=Array.prototype.slice.call(document.querySelectorAll("img[data-original]"));i.length&&("undefined"!=typeof IntersectionObserver?(t=new IntersectionObserver(function(e,t){e.filter(function(e){return e.isIntersecting}).forEach(function(e){r(e.target),t.unobserve(e.target)})}),i.forEach(function(e){t.observe(e)})):(n=function(){clearTimeout(e),e=setTimeout(function(){if(!(i=i.filter(function(e){return!e.src})).length)return window.removeEventListener("scroll",n),void window.removeEventListener("resize",n);i.filter(function(e){e.getBoundingClientRect().top<window.innerHeight&&r(e)})},100)},window.addEventListener("scroll",n),window.addEventListener("resize",n),n()))},!1)}();</script></body></html>