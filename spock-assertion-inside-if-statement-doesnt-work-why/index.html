<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name="author" content="Szymon Stepniak"><meta name="robots" content="index, follow"><meta name="monetization" content="$ilp.uphold.com/Jfxe9Qd9z8Mb"><title>Spock assertion inside if-statement doesn't work - why?</title><meta name="description" content="Spock Framework is one of my favorite tools in the Groovy ecosystem toolbox. It makes writing automated tests a few times more pleasant thanks to its opinionated syntax. From time to time I see some c"><meta property="og:type" content="article"><meta property="og:title" content="Spock assertion inside if-statement doesn&#39;t work - why?"><meta property="og:url" content="https://e.printstacktrace.blog/spock-assertion-inside-if-statement-doesnt-work-why/"><meta property="og:site_name" content="Szymon Stepniak - Freelance Groovy Developer &amp; DevOps"><meta property="og:description" content="Spock Framework is one of my favorite tools in the Groovy ecosystem toolbox. It makes writing automated tests a few times more pleasant thanks to its opinionated syntax. From time to time I see some c"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://e.printstacktrace.blog/images/og/spock-then-assertion-if.jpg"><meta property="article:published_time" content="2018-12-27T18:52:37.000Z"><meta property="article:modified_time" content="2018-12-27T18:52:37.000Z"><meta property="article:author" content="Szymon Stepniak"><meta property="article:tag" content="groovy"><meta property="article:tag" content="spock"><meta property="article:tag" content="testing"><meta property="article:tag" content="java"><meta property="article:tag" content="unit-testing"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="https://e.printstacktrace.blog/images/og/spock-then-assertion-if.jpg"><meta name="twitter:creator" content="@wololock"><meta name="keywords" content="groovy,spock,testing,java,unit-testing"><link rel="dns-prefetch" href="//cdnjs.cloudflare.com"><link rel="dns-prefetch" href="//stackpath.bootstrapcdn.com"><link rel="dns-prefetch" href="//disqus.com"><link rel="dns-prefetch" href="//c.disquscdn.com"><link href="//fonts.googleapis.com/css2?family=Source+Sans+Pro:wght@400;700&amp;display=swap" rel="stylesheet"><link href="//fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&amp;display=swap" rel="stylesheet"><link href="//fonts.googleapis.com/css2?family=Lora:ital,wght@0,400;0,700;1,400&amp;display=swap" rel="stylesheet"><link href="//fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,400;0,700;1,400&amp;display=swap" rel="stylesheet"><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous"><link rel="shortcut icon" type="image/png" href="/favicon_new.png"><link rel="stylesheet" href="/css/main.css?v=57"><link rel="stylesheet" href="/css/highlightjs.css?v=57"><link rel="canonical" href="https://e.printstacktrace.blog/spock-assertion-inside-if-statement-doesnt-work-why/"><script type="application/ld+json">{"@context":"http://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://e.printstacktrace.blog/spock-assertion-inside-if-statement-doesnt-work-why/"},"headline":"Spock assertion inside if-statement doesn't work - why?","image":{"@type":"ImageObject","url":"https://e.printstacktrace.blog/images/og/spock-then-assertion-if.jpg"},"datePublished":"2018-12-27T18:52:37.000Z","dateModified":"2018-12-27T18:52:37.000Z","author":{"@type":"Person","name":"Szymon Stepniak"},"publisher":{"@type":"Organization","name":"Szymon Stepniak - Freelance Groovy Developer & DevOps","logo":{"@type":"ImageObject","url":"https://e.printstacktrace.blog/images/site-logo.jpg","height":60,"width":600}},"description":"Spock Framework is one of my favorite tools in the Groovy ecosystem toolbox. It makes writing automated tests a few times more pleasant thanks to its opinionated syntax. From time to time I see some corner cases where Spock behaves unexpectedly. Today I would like to show you one of these corner cases and explains what happens under the hood.","keywords":"groovy,spock,testing,java,unit-testing"}</script><meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="Szymon Stepniak - Freelance Groovy Developer & DevOps" type="application/atom+xml">
<style>.img-lazyload-container{overflow:hidden;max-width:100%}.img-lazyload-container img{max-width:100%;display:block;height:auto;transition:opacity .5s ease-in-out}.img-lazyload-container img:not([src]){height:0;opacity:0}</style></head><body class="layout-post"><header class="fixed-top" id="header"><div class="container-fluid px-md-auto px-0"><nav class="navbar navbar-expand-lg"><h3 class="logo mr-auto position-relative">e.printstacktrace.blog<a class="stretched-link" href="/"></a></h3><span class="badge badge-info badge-pill h5 ml-2">NEW!</span><button class="navbar-toggler" data-toggle="collapse" data-target="#mainNav" aria-controls="mainNav" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="mainNav"><ul class="navbar-nav ml-lg-auto text-center text-md-left d-block d-lg-flex"><li class="nav-item"><a class="nav-link" href="/">Start here</a></li><li class="nav-item"><a class="nav-link" href="/about">About</a></li><li class="nav-item"><a class="nav-link" href="/support-me">Support me</a></li><li class="nav-item"><a class="nav-link" href="/archives">Archives</a></li><li class="nav-item d-inline-block d-lg-block mx-2 mx-lg-0"><a class="nav-link gatr" href="https://twitter.com/wololock" target="_blank" rel="noopener" data-type="social" data-name="Twitter"><em class="fa fa-twitter"></em></a></li><li class="nav-item d-inline-block d-lg-block mx-2 mx-lg-0"><a class="nav-link gatr" href="https://github.com/wololock" target="_blank" rel="noopener" data-type="social" data-name="GitHub"><em class="fa fa-github"></em></a></li><li class="nav-item d-inline-block d-lg-block mx-2 mx-lg-0"><a class="nav-link gatr" href="https://stackoverflow.com/users/2194470/szymon-stepniak" target="_blank" rel="noopener" data-type="social" data-name="Stack Overflow"><em class="fa fa-stack-overflow"></em></a></li><li class="nav-item d-inline-block d-lg-block mx-2 mx-lg-0"><a class="nav-link gatr" href="https://youtube.com/c/eprintstacktrace" target="_blank" rel="noopener" data-type="social" data-name="YouTube"><em class="fa fa-youtube"></em></a></li></ul></div></nav></div></header><main id="page-post" role="main" itemscope itemtype="http://schema.org/Article"><header class="jumbotron text-center pb-5" style="background-image:url(/img/post-debugger.jpg)"><div class="mask"></div><div class="container pt-5 pb-1"><a class="category mark" href="/groovy-cookbook/">Groovy Cookbook</a><h1 class="mt-2 mt-md-0" itemprop="name">Spock assertion inside if-statement doesn't work - why?</h1><section class="post-meta"><ul><li><time datetime="2018-12-27T18:52:37.000Z" itemprop="datePublished">Dec 27, 2018</time></li><li>7 min. read</li><li><a href="https://e.printstacktrace.blog/spock-assertion-inside-if-statement-doesnt-work-why/#disqus_thread">0 Comments</a></li></ul></section></div></header><article class="post-content" role="article" itemprop="articleBody"><div class="container"><div class="row"><div class="col-12 offset-0 col-md-10 offset-md-1 pt-4 pt-md-5"><div class="paragraph"><p><a href="http://spockframework.org/" target="_blank" rel="noopener">Spock Framework</a> is one of my favorite tools in the Groovy ecosystem toolbox. It makes writing automated tests a few times more pleasant thanks to its opinionated syntax. From time to time I see some corner cases where Spock behaves unexpectedly. Today I would like to show you one of these corner cases and explains what happens under the hood.</p></div><a id="more"></a><div class="sect1"><h2 id="the-basics">The basics</h2><div class="sectionbody"><div class="paragraph"><p>Spock uses a given-when-then structure known from <a href="https://en.wikipedia.org/wiki/Behavior-driven_development" target="_blank" rel="noopener">Behavior-driven development</a>. Its tidy syntax comes with some imposed requirements and limitations, like the one mentioned in the Spock&#8217;s documentation:<sup class="footnote">[<a id="_footnoteref_1" class="footnote" href="#_footnotedef_1" title="View footnote.">1</a>]</sup></p></div><div class="quoteblock"><blockquote><div class="paragraph"><p>The <code>when</code> and <code>then</code> blocks always occur together. They describe a stimulus and the expected response. Whereas <code>when</code> blocks may contain arbitrary code, <code>then</code> blocks are restricted to <em>conditions</em>, <em>exception conditions</em>, <em>interactions</em>, and <em>variable definitions</em>. A feature method may contain multiple pairs of <code>when</code>-<code>then</code> blocks.</p></div></blockquote></div><div class="paragraph"><p>It states clearly what 4 kinds of statements we can use inside <code>then</code> block. Let&#8217;s take a closer look at all of them.</p></div><div class="sect2"><h3 id="1-conditions">1. Conditions</h3><div class="listingblock"><div class="title">Listing 1. An example of the condition in the then block</div><div class="content"><pre class="highlightjs highlight"><code data-lang="groovy" class="language-groovy hljs">then:
expected == result</code></pre></div></div><div class="paragraph"><p>This is a simple expression that compares some <code>result</code> with <code>expected</code> value, which was defined most probably in the <code>given</code> or <code>setup</code> block.</p></div></div><div class="sect2"><h3 id="2-exception-conditions">2. Exception conditions</h3><div class="listingblock"><div class="title">Listing 2. An example of an exception condition in the then block</div><div class="content"><pre class="highlightjs highlight"><code data-lang="groovy" class="language-groovy hljs">then:
thrown IllegalArgumentException</code></pre></div></div><div class="paragraph"><p>In this example we define expectation - an exception of a specific type has to be thrown.</p></div></div><div class="sect2"><h3 id="3-interactions">3. Interactions</h3><div class="listingblock"><div class="title">Listing 3. An example of interaction expectation in the then block</div><div class="content"><pre class="highlightjs highlight"><code data-lang="groovy" class="language-groovy hljs">then:
1 * foo.bar() &gt;&gt; "Hello!"</code></pre></div></div><div class="paragraph"><p>In this example, we say that we expect that <code>foo.bar()</code> method gets called exactly one time, and it returns <code>"Hello"</code> value.</p></div></div><div class="sect2"><h3 id="4-variable-definitions">4. Variable definitions</h3><div class="listingblock"><div class="title">Listing 4. An example of variable definition in the then block</div><div class="content"><pre class="highlightjs highlight"><code data-lang="groovy" class="language-groovy hljs">then:
def expected = 10
result == expected</code></pre></div></div><div class="paragraph"><p>So here&#8217;s the last available statement type - variable definition. As you can see you can define any variable inside the <code>then</code> block, however, this is not a good practice. The <code>then</code> block should be as small and smooth as possible, and this variable definition adds nothing else than noise. In some specific use cases, it might make more sense to do so, but it&#8217;s usually a better choice to consider <code>given</code> or <code>setup</code> blocks for variable definitions.</p></div></div></div></div><div class="sect1"><h2 id="using-if-statement-in-the-then-block">Using if-statement in the <code>then</code> block</h2><div class="sectionbody"><div class="paragraph"><p>Now when we have recapped basic concepts of Spock&#8217;s <code>then</code> block structure, let&#8217;s take a look at some unusual example. Below you can find a simple Spock unit test that contains 3 methods. The expectation is that all of them fail because of unsatisfied assertion.</p></div><div class="listingblock"><div class="title">Listing 5. All of these test methods should fail</div><div class="content"><pre class="highlightjs highlight"><code data-lang="groovy" class="language-groovy hljs">import groovy.transform.CompileStatic
import spock.lang.Specification

@CompileStatic
class SpockThenSpecialUseCase extends Specification {

    def "(1) should fail on expected == result comparison"() {
        given:
        def expected = "Hello, John!"

        when:
        def result = "Hello, Joe!"

        then:
        expected == result
    }

    def "(2) should fail on expected == result comparison"() {
        given:
        def expected = "Hello, John!"

        when:
        def result = "Hello, Joe!"

        then:
        if (expected) {
            expected == result
        }
    }

    def "(3) should fail on expected == result comparison"() {
        given:
        def expected = "Hello, John!"

        when:
        def result = "Hello, Joe!"

        then:
        if (expected) {
            assert expected == result
        }
    }
}</code></pre></div></div><div class="paragraph"><p>When we run this test we will see the following result:</p></div><div class="openblock text-center"><div class="content"><div class="imageblock img-responsive img-thumbnail"><div class="content"><a class="image" href="/images/spock-then-if-assertion.png"><div class="img-lazyload-container" style="width:939px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==);background-repeat:no-repeat;background-position:center"><img data-original="/images/spock-then-if-assertion.png" height="261" width="939" style="padding-top:27.79552715654952%"></div></a></div></div></div></div><div class="paragraph"><p>The second test case didn&#8217;t fail as expected. The answer is clear and straightforward - if-statement does not fit to any of 4 statements we have described in the previous section.</p></div></div></div><div class="sect1"><h2 id="looking-for-an-answer">Looking for an answer</h2><div class="sectionbody"><div class="paragraph"><p>I&#8217;m pretty sure this simple answer does not satisfy your pursuit to better understanding what happens under the hood. Let&#8217;s dig one level down and see what the decompiled bytecode of this class looks like.</p></div><div class="listingblock"><div class="title">Listing 6. Spock test decompiled from <code>.class</code> file to Java</div><div class="content"><pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">//
// Source code recreated from a .class file by IntelliJ IDEA
// (powered by Fernflower decompiler)
//

import groovy.lang.GroovyObject;
import org.codehaus.groovy.runtime.ScriptBytecodeAdapter;
import org.codehaus.groovy.runtime.typehandling.DefaultTypeTransformation;
import org.spockframework.runtime.ErrorCollector;
import org.spockframework.runtime.SpockRuntime;
import org.spockframework.runtime.ValueRecorder;
import org.spockframework.runtime.model.BlockKind;
import org.spockframework.runtime.model.BlockMetadata;
import org.spockframework.runtime.model.FeatureMetadata;
import org.spockframework.runtime.model.SpecMetadata;
import spock.lang.Specification;

@SpecMetadata(
    filename = "SpockThenSpecialUseCase.groovy",
    line = 4
)
public class SpockThenSpecialUseCase extends Specification implements GroovyObject {
    public SpockThenSpecialUseCase() {
    }

    @FeatureMetadata(
        line = 7,
        name = "(1) should fail on expected == result comparison",
        ordinal = 0,
        blocks = {@BlockMetadata(
    kind = BlockKind.SETUP,
    texts = {}
), @BlockMetadata(
    kind = BlockKind.WHEN,
    texts = {}
), @BlockMetadata(
    kind = BlockKind.THEN,
    texts = {}
)},
        parameterNames = {}
    )
    public void $spock_feature_0_0() { <i class="conum" data-value="1"></i><b>(1)</b>
        ErrorCollector $spock_errorCollector = new ErrorCollector(false);
        ValueRecorder $spock_valueRecorder = new ValueRecorder();

        Object var10000;
        try {
            String expected = "Hello, John!";
            String result = "Hello, Joe!";

            try {
                SpockRuntime.verifyCondition($spock_errorCollector, $spock_valueRecorder.reset(), "expected == result", Integer.valueOf(15), Integer.valueOf(9), (Object)null, $spock_valueRecorder.record($spock_valueRecorder.startRecordingValue(Integer.valueOf(2)), ScriptBytecodeAdapter.compareEqual($spock_valueRecorder.record($spock_valueRecorder.startRecordingValue(Integer.valueOf(0)), expected), $spock_valueRecorder.record($spock_valueRecorder.startRecordingValue(Integer.valueOf(1)), result))));
                var10000 = null;
            } catch (Throwable var14) {
                SpockRuntime.conditionFailedWithException($spock_errorCollector, $spock_valueRecorder, "expected == result", Integer.valueOf(15), Integer.valueOf(9), (Object)null, var14);
                var10000 = null;
            } finally {
                ;
            }

            ScriptBytecodeAdapter.invokeMethod0(SpockThenSpecialUseCase.class, ((SpockThenSpecialUseCase)this).getSpecificationContext().getMockController(), (String)"leaveScope");
        } finally {
            $spock_errorCollector.validateCollectedErrors();
            var10000 = null;
        }

    }

    @FeatureMetadata(
        line = 18,
        name = "(2) should fail on expected == result comparison",
        ordinal = 1,
        blocks = {@BlockMetadata(
    kind = BlockKind.SETUP,
    texts = {}
), @BlockMetadata(
    kind = BlockKind.WHEN,
    texts = {}
), @BlockMetadata(
    kind = BlockKind.THEN,
    texts = {}
)},
        parameterNames = {}
    )
    public void $spock_feature_0_1() { <i class="conum" data-value="2"></i><b>(2)</b>
        String expected = "Hello, John!";
        String result = "Hello, Joe!";
        if (DefaultTypeTransformation.booleanUnbox(expected)) {
            ScriptBytecodeAdapter.compareEqual(expected, result);
        }

        ScriptBytecodeAdapter.invokeMethod0(SpockThenSpecialUseCase.class, ((SpockThenSpecialUseCase)this).getSpecificationContext().getMockController(), (String)"leaveScope");
    }

    @FeatureMetadata(
        line = 31,
        name = "(3) should fail on expected == result comparison",
        ordinal = 2,
        blocks = {@BlockMetadata(
    kind = BlockKind.SETUP,
    texts = {}
), @BlockMetadata(
    kind = BlockKind.WHEN,
    texts = {}
), @BlockMetadata(
    kind = BlockKind.THEN,
    texts = {}
)},
        parameterNames = {}
    )
    public void $spock_feature_0_2() { <i class="conum" data-value="3"></i><b>(3)</b>
        ErrorCollector $spock_errorCollector = new ErrorCollector(false);
        ValueRecorder $spock_valueRecorder = new ValueRecorder();

        Object var10000;
        try {
            String expected = "Hello, John!";
            String result = "Hello, Joe!";
            if (DefaultTypeTransformation.booleanUnbox(expected)) {
                try {
                    SpockRuntime.verifyCondition($spock_errorCollector, $spock_valueRecorder.reset(), "expected == result", Integer.valueOf(40), Integer.valueOf(20), (Object)null, $spock_valueRecorder.record($spock_valueRecorder.startRecordingValue(Integer.valueOf(2)), ScriptBytecodeAdapter.compareEqual($spock_valueRecorder.record($spock_valueRecorder.startRecordingValue(Integer.valueOf(0)), expected), $spock_valueRecorder.record($spock_valueRecorder.startRecordingValue(Integer.valueOf(1)), result))));
                    var10000 = null;
                } catch (Throwable var14) {
                    SpockRuntime.conditionFailedWithException($spock_errorCollector, $spock_valueRecorder, "expected == result", Integer.valueOf(40), Integer.valueOf(20), (Object)null, var14);
                    var10000 = null;
                } finally {
                    ;
                }
            }

            ScriptBytecodeAdapter.invokeMethod0(SpockThenSpecialUseCase.class, ((SpockThenSpecialUseCase)this).getSpecificationContext().getMockController(), (String)"leaveScope");
        } finally {
            $spock_errorCollector.validateCollectedErrors();
            var10000 = null;
        }

    }
}</code></pre></div></div><div class="paragraph"><p>The Java code doesn&#8217;t look as smooth as Groovy one, but we can quickly spot the most interesting parts. The method <em class="conum" data-value="1"></em> shows what does the decompiled bytecode representation looks like. We can see that the following Spock part:</p></div><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code data-lang="groovy" class="language-groovy hljs">then:
expected == result</code></pre></div></div><div class="paragraph"><p>gets replaced by something like this (method call formatted for better readability):</p></div><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">SpockRuntime.verifyCondition(
    $spock_errorCollector,
    $spock_valueRecorder.reset(),
    "expected == result",
    Integer.valueOf(15),
    Integer.valueOf(9),
    (Object)null,
    $spock_valueRecorder.record(
        $spock_valueRecorder.startRecordingValue(Integer.valueOf(2)),
        ScriptBytecodeAdapter.compareEqual(
            $spock_valueRecorder.record($spock_valueRecorder.startRecordingValue(Integer.valueOf(0)), expected),
            $spock_valueRecorder.record($spock_valueRecorder.startRecordingValue(Integer.valueOf(1)), result)
        )
    )
);</code></pre></div></div><div class="paragraph"><p>Spock uses its custom compiler which modifies abstract syntax tree (AST) of your unit test. It checks if the <code>then</code> (and any other) block meets requirements and rewrites it. There are two methods we could start investigation from to get a better understanding of what Spock does under the hood:</p></div><div class="ulist"><ul><li><p><a href="https://github.com/spockframework/spock/blob/spock-1.2/spock-core/src/main/java/org/spockframework/compiler/SpecRewriter.java#L322-L338" target="_blank" rel="noopener"><code>org.spockframework.compiler.SpecRewriter.visitThenBlock()</code></a></p></li><li><p><a href="https://github.com/spockframework/spock/blob/spock-1.2/spock-core/src/main/java/org/spockframework/compiler/DeepBlockRewriter.java#L141-L164" target="_blank" rel="noopener"><code>org.spockframework.compiler.DeepBlockRewriter.handleImplicitCondition()</code></a></p></li></ul></div><div class="paragraph"><p>Now, let&#8217;s take a quick look at the <em class="conum" data-value="2"></em> test case that used if-statement inside the <code>then</code> block and passed:</p></div><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public void $spock_feature_0_1() {
    String expected = "Hello, John!";
    String result = "Hello, Joe!";
    if (DefaultTypeTransformation.booleanUnbox(expected)) {
        ScriptBytecodeAdapter.compareEqual(expected, result);
    }

    ScriptBytecodeAdapter.invokeMethod0(SpockThenSpecialUseCase.class, ((SpockThenSpecialUseCase)this).getSpecificationContext().getMockController(), (String)"leaveScope");
}</code></pre></div></div><div class="paragraph"><p>It looks like not a single line of code got modified the AST. It happened because Spock&#8217;s compiler didn&#8217;t find a valid statement for a <code>then</code> block and thus it didn&#8217;t have to rewrite anything.</p></div><div class="paragraph"><p>A different situation takes place in the example <em class="conum" data-value="3"></em>. Here we have called <code>assert</code> explicitly, and it was an explicit instruction for Spock&#8217;s compiler to modify AST. The if-statement is still here, but the following part:</p></div><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code data-lang="groovy" class="language-groovy hljs">then:
if (expected) {
    assert expected == result
}</code></pre></div></div><div class="paragraph"><p>was compiled to a following code (decompiled Java representation):</p></div><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">if (DefaultTypeTransformation.booleanUnbox(expected)) {
    try {
        SpockRuntime.verifyCondition(
            $spock_errorCollector,
            $spock_valueRecorder.reset(),
            "expected == result",
            Integer.valueOf(40),
            Integer.valueOf(20),
            (Object)null,
            $spock_valueRecorder.record(
                $spock_valueRecorder.startRecordingValue(Integer.valueOf(2)),
                ScriptBytecodeAdapter.compareEqual(
                    $spock_valueRecorder.record($spock_valueRecorder.startRecordingValue(Integer.valueOf(0)), expected),
                    $spock_valueRecorder.record($spock_valueRecorder.startRecordingValue(Integer.valueOf(1)), result)
                )
            )
        );
        var10000 = null;
    } catch (Throwable var14) {
        SpockRuntime.conditionFailedWithException($spock_errorCollector, $spock_valueRecorder, "expected == result", Integer.valueOf(40), Integer.valueOf(20), (Object)null, var14);
        var10000 = null;
    } finally {
        ;
    }
}</code></pre></div></div><div class="paragraph"><p>As we can see Spock understands explicit <code>assert</code> instruction and passes its condition to&nbsp;a&nbsp; <code>SpockRuntime.verifyCondition()</code> method as shown above.</p></div></div></div><div class="sect1"><h2 id="conclusion">Conclusion</h2><div class="sectionbody"><div class="paragraph"><p>I hope you find this article interesting. Don&#8217;t hesitate to leave a comment in the section below. Maybe you have experienced some unexpected Spock behavior - please share your story with the rest of us. Take care and see you next time!</p></div><div class="paragraph mt-5"><p>Share this blog post on <span class="icon color-twitter"><i class="fa fa-twitter"></i></span> <a href="https://twitter.com/intent/tweet?text=%22Spock%20assertion%20inside%20if-statement%20doesn't%20work%20-%20why?%22%20https://e.printstacktrace.blog/spock-assertion-inside-if-statement-doesnt-work-why/%20via%20@wololock" target="_blank" rel="noopener">Twitter</a> or <span class="icon color-linkedin"><i class="fa fa-linkedin-square"></i></span> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https://e.printstacktrace.blog/spock-assertion-inside-if-statement-doesnt-work-why/&title=Spock%20assertion%20inside%20if-statement%20doesn't%20work%20-%20why?" target="_blank" rel="noopener">LinkedIn</a> to help me spread the word. Thanks! <span class="icon"><i class="fa fa-smile-o"></i></span></p></div></div></div><div id="footnotes"><hr><div class="footnote" id="_footnotedef_1"><a href="#_footnoteref_1">1</a>. <a href="http://spockframework.org/spock/docs/1.2/spock_primer.html#_when_and_then_blocks" target="_blank" rel="noopener" class="bare">http://spockframework.org/spock/docs/1.2/spock_primer.html#_when_and_then_blocks</a></div></div></div><div class="col-12 offset-0 col-md-10 offset-md-1"><div class="post-tags"><ul><li class="text"><em class="far fa-calendar-alt mr-1"></em>Published: Dec 27, 2018 in <a class="mark" href="/groovy-cookbook/">Groovy Cookbook</a></li></ul><ul class="mt-2"><li class="text"><em class="fas fa-tags"></em></li><li><a href="/t/groovy/">groovy</a></li><li><a href="/t/java/">java</a></li><li><a href="/t/spock/">spock</a></li><li><a href="/t/testing/">testing</a></li><li><a href="/t/unit-testing/">unit-testing</a></li></ul></div></div></div></div><footer class="post-footer"><div class="container"><div class="row"><div class="col-12 offset-0 col-md-10 offset-md-1"><div class="about-author"><div class="row"><div class="col-md-2 col-6 offset-md-0 offset-3 text-center mt-4"><img class="rounded-circle img-fluid" src="https://www.gravatar.com/avatar/b22c1842c6e8f7f2b9b3ed8c0d4efb4d?s=200"></div><div class="col-md-10 col-12 text-md-left text-center mt-md-4 mt-1"><h4 class="text-md-left text-center" itemprop="creator"><a class="gatr" href="/about" data-type="post-footer" data-name="About">Szymon Stepniak</a></h4><p class="bio"><span>Groovista, Upwork's Top Rated freelancer, Toruń Java User Group founder, open&nbsp;source contributor, Stack Overflow addict, bedroom guitar player. I walk through e.printStackTrace() so you don't have to.</span><span class="ml-2"><a href="/about">More about me &raquo;</a></span></p><ul class="social-links text-md-left text-center"><li><a class="gatr" href="https://twitter.com/wololock" target="_blank" rel="noopener" onclick="return window.open(this.href),!1" data-type="post-footer" data-name="twitter"><span class="fa fa-twitter"></span></a></li><li><a class="gatr" href="https://github.com/wololock" target="_blank" rel="noopener" onclick="return window.open(this.href),!1" data-type="post-footer" data-name="github"><span class="fa fa-github"></span></a></li><li><a class="gatr" href="https://stackoverflow.com/users/2194470/szymon-stepniak?tab=profile" target="_blank" rel="noopener" onclick="return window.open(this.href),!1" data-type="post-footer" data-name="stackoverflow"><span class="fa fa-stack-overflow"></span></a></li><li><a class="gatr" href="https://www.youtube.com/c/eprintstacktrace" target="_blank" rel="noopener" onclick="return window.open(this.href),!1" data-type="post-footer" data-name="youtube"><span class="fa fa-youtube"></span></a></li></ul></div></div></div></div></div></div></footer></article></main><section class="related-posts"><div class="container"><h3>Related posts</h3><div class="card-deck pt-2"><article class="card shadow-sm" itemscope itemtype="http://schema.org/Article"><div class="card-header" itemprop="image" style="background-image:url(/images/og/groovy-junit-assume-notnull-npe.jpg)"><div class="mask"></div><h3 class="h5 text-left font-weight-bold text-white" itemprop="name"><div><a class="category">Groovy Cookbook</a></div><div class="title">JUnit Assume.assumeNotNull(obj) throws NullPointerException in Groovy - what's wrong?</div></h3></div><div class="card-body"><section class="post-meta"><ul><li><time datetime="2018-12-20T23:49:07.000Z" itemprop="datePublished">Dec 21, 2018</time></li><li>5 min. read</li><li><a href="https://e.printstacktrace.blog/junit-assume-notnull-throws-nullpointerexception-in-groovy-whats-wrong/#disqus_thread">0 Comments</a></li></ul></section><p class="card-text pt-3" itemprop="description">Ignoring some of the unit tests when given conditions are not satisfied is a handy feature of a JUnit framework. I guess you have used many times constructions like Assume.assumeTrue(expr) or Assume.assumeNotNull(expr) in your test code. Today I would like to show you one pretty interesting cor ...</p></div><a class="stretched-link gatr" href="/junit-assume-notnull-throws-nullpointerexception-in-groovy-whats-wrong/" itemprop="url" data-type="related" data-name="JUnit Assume.assumeNotNull(obj) throws NullPointerException in Groovy - what's wrong?"></a></article><article class="card shadow-sm" itemscope itemtype="http://schema.org/Article"><div class="card-header" itemprop="image" style="background-image:url(/images/cards/groovy-01.jpg)"><div class="mask"></div><h3 class="h5 text-left font-weight-bold text-white" itemprop="name"><div><a class="category">Groovy Cookbook</a></div><div class="title">How Groovy's equal operator differs from Java?</div></h3></div><div class="card-body"><section class="post-meta"><ul><li><time datetime="2018-09-22T07:53:42.000Z" itemprop="datePublished">Sep 22, 2018</time></li><li>7 min. read</li><li><a href="https://e.printstacktrace.blog/how-groovy-equal-operator-is-different-from-java/#disqus_thread">0 Comments</a></li></ul></section><p class="card-text pt-3" itemprop="description">One of the first mistakes people do when starting their journey with Java programming language is using == to compare objects instead calling a.equals(b). When you begin playing around with Groovy you quickly notice that equal operator == is used to compare objects in place of calling a.equals( ...</p></div><a class="stretched-link gatr" href="/how-groovy-equal-operator-is-different-from-java/" itemprop="url" data-type="related" data-name="How Groovy's equal operator differs from Java?"></a></article><article class="card shadow-sm" itemscope itemtype="http://schema.org/Article"><div class="card-header" itemprop="image" style="background-image:url(/images/cards/groovy-02.jpg)"><div class="mask"></div><h3 class="h5 text-left font-weight-bold text-white" itemprop="name"><div><a class="category">Groovy Cookbook</a></div><div class="title">What is the most efficient way to iterate collection in Groovy? Let's play with JMH!</div></h3></div><div class="card-body"><section class="post-meta"><ul><li><time datetime="2018-10-02T10:43:26.000Z" itemprop="datePublished">Oct 2, 2018</time></li><li>9 min. read</li><li><a href="https://e.printstacktrace.blog/what-is-the-most-efficient-way-to-iterate-collection-in-groovy-jmh/#disqus_thread">0 Comments</a></li></ul></section><p class="card-text pt-3" itemprop="description">I guess you may heard about Groovy&#8217;s Collection.each(Closure cl) method - it was introduced 15 years ago [1] and it was a great alternative for a good old for-loop, for-each or even using an iterator approach. You may also heard, that you should not overuse it, because creating a closure ...</p></div><a class="stretched-link gatr" href="/what-is-the-most-efficient-way-to-iterate-collection-in-groovy-jmh/" itemprop="url" data-type="related" data-name="What is the most efficient way to iterate collection in Groovy? Let's play with JMH!"></a></article></div></div><div class="col-12 text-center mt-5 serif"><h5 class="h3"><span class="small d-block mb-2">More posts from</span><span class="font-weight-bold mark">Groovy Cookbook</span></h5><div><em class="fas fa-angle-down"></em></div><a class="stretched-link" href="/groovy-cookbook/"></a></div></section><div class="container py-5"><div class="disqus-comments"><div class="alert alert-info small"><em class="fa fa-info-circle"></em> Want to paste code in the comment and make the formatting look good? Read this - <a href="https://help.disqus.com/en/articles/1717236-syntax-highlighting" target="_blank" rel="noopener"><b>Syntax highlighting</b></a>.</div><div class="comments"><div id="disqus_thread"><div id="disqus_empty" style="display:none">Empty</div></div></div></div><script>function load_disqus(e){var t=document.getElementById("disqus_empty");if(document.contains(t)){var d=document.getElementById("disqus_thread"),n=document.createElement("script"),s=document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0];d&&t&&(t.remove(),n.type="text/javascript",n.async=!0,n.src="//"+e+".disqus.com/embed.js",s.appendChild(n))}}window.addEventListener("scroll",function(e){document.scrollingElement.scrollTop>document.getElementById("disqus_thread").offsetTop-500&&load_disqus("eprintstacktrace")},!1)</script></div><footer class="page-footer"><section class="links"><div class="container"><div class="row"><div class="col-12 col-md-4"><h5 class="text-md-left text-center">Useful links</h5><ul class="text-md-left text-center mb-md-0 mb-5"><li><a class="gatr" href="/" data-type="footer-useful-links" data-name="Start here">Start here</a></li><li><a class="gatr" href="/about" data-type="footer-useful-links" data-name="About">About</a></li><li><a class="gatr" href="/archives" data-type="footer-useful-links" data-name="Archives">Archives</a></li><li><a class="gatr" href="/privacy-policy" data-type="footer-useful-links" data-name="Privacy Policy">Privacy Policy</a></li><li><a class="gatr" href="https://kit.co/wololock" target="_blank" rel="noopener" data-type="footer-useful-links" data-name="My Kit">My Kit</a></li><li><a class="gatr" href="https://feeds.feedburner.com/Eprintstacktracenet" target="_blank" rel="noopener" data-type="footer-useful-links" data-name="RSS">RSS</a></li><li><a class="gatr" href="/support-me" data-type="footer-useful-links" data-name="Support me">Support me <em class="fas fa-heart color-red ml-2"></em></a></li></ul></div><div class="col-12 col-md-4"><h5 class="text-md-left text-center">Popular categories</h5><ul class="text-md-left text-center mb-md-0 mb-5"><li><a class="gatr" href="/groovy-cookbook/" data-type="footer-category" data-name="Groovy Cookbook">Groovy Cookbook<span class="count ml-2">26</span></a></li><li><a class="gatr" href="/jenkins-pipeline-cookbook/" data-type="footer-category" data-name="Jenkins Pipeline Cookbook">Jenkins Pipeline Cookbook<span class="count ml-2">7</span></a></li><li><a class="gatr" href="/programmers-bookshelf/" data-type="footer-category" data-name="Programmer's Bookshelf">Programmer's Bookshelf<span class="count ml-2">6</span></a></li><li><a class="gatr" href="/ratpack-cookbook/" data-type="footer-category" data-name="Ratpack Cookbook">Ratpack Cookbook<span class="count ml-2">4</span></a></li><li><a class="gatr" href="/learning-java/" data-type="footer-category" data-name="Learning Java">Learning Java<span class="count ml-2">4</span></a></li><li><a class="gatr" href="/how-to/" data-type="footer-category" data-name="How to">How to<span class="count ml-2">3</span></a></li><li><a class="gatr" href="/micronaut-cookbook/" data-type="footer-category" data-name="Micronaut Cookbook">Micronaut Cookbook<span class="count ml-2">3</span></a></li></ul></div><div class="col-12 col-md-4 text-center"><a class="gatr" href="https://www.jdoqocy.com/click-100154593-12490428" target="_blank" rel="noopener" data-type="banner" data-name="Grammarly Footer Default"><img class="img-fluid" src="/images/yml/grammarly-square-2.png"></a></div></div></div></section><section class="bottom"><div class="container"><ul class="text-center py-2"><li class="d-inline-block mb-md-0 mb-2">Designed by <a class="gatr" href="https://twitter.com/wololock" target="_blank" rel="noopener" data-type="footer" data-name="designed">@wololock</a></li><li class="d-inline-block mb-md-0 mb-2">Created with <a class="gatr" href="https://hexo.io" target="_blank" rel="noopener" data-type="footer" data-name="hexo">Hexo</a></li><li class="d-inline-block mb-md-0 mb-2">Hosted on <a class="gatr" href="https://github.com/wololock/wololock.github.io" target="_blank" rel="noopener" data-type="footer" data-name="github">GitHub</a></li><li class="d-inline-block mb-md-0 mb-2">Deployed with <a class="gatr" href="https://circleci.com/gh/wololock/wololock.github.io" target="_blank" rel="noopener" data-type="footer" data-name="circleci">Circle CI</a></li><li class="d-inline-block mb-md-0 mb-2">License <a class="gatr" href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener" data-type="footer" data-name="license">CC BY-NC-SA 4.0</a></li><li class="d-inline-block mb-md-0 mb-2"><a class="gatr" href="https://github.com/wololock/wololock.github.io/commits/develop" target="_blank" rel="noopener" data-type="footer" data-name="last-commit"><img src="https://badgen.net/github/last-commit/wololock/wololock.github.io?color=blue&amp;scale=0.8"></a></li></ul></div></section></footer><script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script><script async src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script><script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js" integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI" crossorigin="anonymous"></script><script async src="https://kit.fontawesome.com/25fc8ffdd1.js" crossorigin="anonymous"></script><script async id="cookiebanner" src="//cdnjs.cloudflare.com/ajax/libs/cookie-banner/1.2.2/cookiebanner.min.js" data-moreinfo="/privacy-policy/" data-message="This blog uses cookies to enhance your experience. By continuing to visit it you agree to its use of cookies." data-link="#ffad33" data-font-family="Lora,serif" data-font-size="15px" data-bg="#444"></script><script src="/js/highlight.pack.js?v=10.0.3"></script><script>hljs.initHighlightingOnLoad()</script><script async src="/js/main.js?v=6"></script><script async id="dsq-count-scr" src="//eprintstacktrace.disqus.com/count.js"></script><script>!function(a,e,t,n,c,g,r){a.GoogleAnalyticsObject=c,a.ga=a.ga||function(){(a.ga.q=a.ga.q||[]).push(arguments)},a.ga.l=1*new Date,g=e.createElement(t),r=e.getElementsByTagName(t)[0],g.async=1,g.src="//www.google-analytics.com/analytics.js",r.parentNode.insertBefore(g,r)}(window,document,"script",0,"ga"),ga("create","UA-42400890-5","auto"),ga("send","pageview"),jQuery("a.gatr").click(function(){var a=jQuery(this),e=a.attr("data-type"),t=a.attr("data-name");return ga("send","event",e,"click",t),!0})</script><script>!function(){"use strict";function r(e){var t=e.getAttribute("data-original"),n=new Image;n.onload=function(){e.setAttribute("src",t),e.style.paddingTop=""},n.src=t}document.addEventListener("DOMContentLoaded",function(){var t,e,n,i=Array.prototype.slice.call(document.querySelectorAll("img[data-original]"));i.length&&("undefined"!=typeof IntersectionObserver?(t=new IntersectionObserver(function(e,t){e.filter(function(e){return e.isIntersecting}).forEach(function(e){r(e.target),t.unobserve(e.target)})}),i.forEach(function(e){t.observe(e)})):(n=function(){clearTimeout(e),e=setTimeout(function(){return(i=i.filter(function(e){return!e.src})).length?void i.filter(function(e){e.getBoundingClientRect().top<window.innerHeight&&r(e)}):(window.removeEventListener("scroll",n),void window.removeEventListener("resize",n))},100)},window.addEventListener("scroll",n),window.addEventListener("resize",n),n()))},!1)}();</script></body></html>