<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="author" content="Szymon Stepniak"><meta name="robots" content="all"><title>Spock assertion inside if-statement doesn't work - why?</title><meta name="description" content="Spock Framework is one of my favorite tools in the Groovy ecosystem toolbox. It makes writing automated tests a few times more pleasant thanks to its opinionated syntax. From time to time I see some corner cases where Spock behaves unexpectedly. Today ..."><meta name="keywords" content="groovy,spock,java,testing,unit-testing"><link rel="shortcut icon" type="image/png" href="/favicon_new.png"><link rel="dns-prefetch" href="//cdnjs.cloudflare.com"><link rel="dns-prefetch" href="//maxcdn.bootstrapcdn.com"><link rel="dns-prefetch" href="//disqus.com"><link rel="dns-prefetch" href="//c.disquscdn.com"><link rel="canonical" href="https://e.printstacktrace.blog/spock-assertion-inside-if-statement-doesnt-work-why/"><link rel="alternate" type="application/rss+xml" title="e.printStackTrace(); // Blog" href="/atom.xml"><link rel="preload" as="style" onload='this.onload=null,this.rel="stylesheet"' href="//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"><link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"><noscript><link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"></noscript><link rel="preload" as="style" onload='this.onload=null,this.rel="stylesheet"' href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/androidstudio.min.css"><link rel="stylesheet" href="/css/main.css?v=47"><link rel="preload" as="style" onload='this.onload=null,this.rel="stylesheet"' href="/css/conum.css?v=47"><noscript><link rel="stylesheet" href="/css/conum.css?v=47"></noscript><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic&amp;display=swap"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800&amp;display=swap"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Code+Pro&amp;display=swap"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Droid+Sans+Mono:400,700&amp;display=swap"><meta name="description" content="Spock Framework is one of my favorite tools in the Groovy ecosystem toolbox. It makes writing automated tests a few times more pleasant thanks to its opinionated syntax. From time to time I see some c"><meta property="og:type" content="article"><meta property="og:title" content="Spock assertion inside if-statement doesn&#39;t work - why?"><meta property="og:url" content="https://e.printstacktrace.blog/spock-assertion-inside-if-statement-doesnt-work-why/"><meta property="og:site_name" content="e.printStackTrace(); &#x2F;&#x2F; Blog"><meta property="og:description" content="Spock Framework is one of my favorite tools in the Groovy ecosystem toolbox. It makes writing automated tests a few times more pleasant thanks to its opinionated syntax. From time to time I see some c"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://e.printstacktrace.blog/images/og/spock-then-assertion-if.jpg"><meta property="article:published_time" content="2018-12-27T18:52:37.000Z"><meta property="article:modified_time" content="2018-12-27T18:52:37.000Z"><meta property="article:author" content="Szymon Stepniak"><meta property="article:tag" content="groovy"><meta property="article:tag" content="spock"><meta property="article:tag" content="java"><meta property="article:tag" content="testing"><meta property="article:tag" content="unit-testing"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="https://e.printstacktrace.blog/images/og/spock-then-assertion-if.jpg"><meta name="twitter:creator" content="@wololock"><script type="application/ld+json">{"@context":"http://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://e.printstacktrace.blog/spock-assertion-inside-if-statement-doesnt-work-why/"},"headline":"Spock assertion inside if-statement doesn't work - why?","image":{"@type":"ImageObject","url":"https://e.printstacktrace.blog/images/og/spock-then-assertion-if.jpg"},"datePublished":"2018-12-27T18:52:37.000Z","dateModified":"2018-12-27T18:52:37.000Z","author":{"@type":"Person","name":"Szymon Stepniak"},"publisher":{"@type":"Organization","name":"e.printStackTrace(); // Blog","logo":{"@type":"ImageObject","url":"https://e.printstacktrace.blog/images/site-logo.jpg","height":60,"width":600}},"description":"Spock Framework is one of my favorite tools in the Groovy ecosystem toolbox. It makes writing automated tests a few times more pleasant thanks to its opinionated syntax. From time to time I see some corner cases where Spock behaves unexpectedly. Today I would like to show you one of these corner cases and explains what happens under the hood.","keywords":"groovy,spock,java,testing,unit-testing"}</script><meta name="generator" content="Hexo 4.2.1"><style>.img-lazyload-container{overflow:hidden;max-width:100%}.img-lazyload-container img{max-width:100%;display:block;height:auto;transition:opacity .5s ease-in-out}.img-lazyload-container img:not([src]){height:0;opacity:0}</style></head><body class="layout-post"><nav class="navbar navbar-default navbar-fixed-top navbar-custom"><div class="container-fluid"><div class="navbar-header"><button class="navbar-toggle" type="button" data-toggle="collapse" data-target="#main-navbar"><span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><a class="navbar-brand" href="/"><span>e.printStackTrace(); // Blog</span></a></div><div class="collapse navbar-collapse" id="main-navbar"><ul class="nav navbar-nav navbar-right"><li><a href="/archives">Archive</a></li><li><a href="https://github.com/wololock/wololock.github.io" target="_blank" rel="noopener">GitHub</a></li><li><a href="/youtube">YouTube</a></li><li><a class="stack-overflow" href="https://stackoverflow.com/users/2194470/szymon-stepniak?tab=profile" target="_blank" rel="noopener"><img class="so-icon" src="/img/so.png"><b class="rep">27,243</b><span class="badges"><span class="gold"><span class="b">●</span><span class="c">9</span></span><span class="silver"><span class="b">●</span><span class="c">61</span></span><span class="bronze"><span class="b">●</span><span class="c">94</span></span></span></a></li></ul></div></div></nav><header class="header-section"><div class="intro-header" style="background-image:url(/img/post-debugger.jpg)"><div class="container"><div class="row"><div class="col-lg-10 col-lg-offset-1 col-md-10 col-md-offset-1"><div class="post-heading"><a class="category" href="/tales-from-debugger/">Tales from debugger</a><h1>Spock assertion inside if-statement doesn't work - why?</h1><div class="post-meta"><ul><li><time datetime="2018-12-27T18:52:37.000Z" itemprop="datePublished">Dec 27, 2018</time></li><li>8 minutes read</li><li><a href="https://e.printstacktrace.blog/spock-assertion-inside-if-statement-doesnt-work-why/#disqus_thread">0 Comments</a></li></ul><section class="post-tags"><ul class="tags"><li><a class="tag post-meta" href="/t/groovy/">groovy</a></li><li><a class="tag post-meta" href="/t/spock/">spock</a></li><li><a class="tag post-meta" href="/t/java/">java</a></li><li><a class="tag post-meta" href="/t/testing/">testing</a></li><li><a class="tag post-meta" href="/t/unit-testing/">unit-testing</a></li></ul></section></div></div></div></div></div></div></header><div class="container"><div class="row"><div class="col-lg-10 col-lg-offset-1 col-md-10 col-md-offset-1"><article class="blog-post" role="main"><div class="paragraph"><p><a href="http://spockframework.org/" target="_blank" rel="noopener">Spock Framework</a> is one of my favorite tools in the Groovy ecosystem toolbox. It makes writing automated tests a few times more pleasant thanks to its opinionated syntax. From time to time I see some corner cases where Spock behaves unexpectedly. Today I would like to show you one of these corner cases and explains what happens under the hood.</p></div><a id="more"></a><div class="sect1"><h2 id="the-basics">The basics</h2><div class="sectionbody"><div class="paragraph"><p>Spock uses a given-when-then structure known from <a href="https://en.wikipedia.org/wiki/Behavior-driven_development" target="_blank" rel="noopener">Behavior-driven development</a>. Its tidy syntax comes with some imposed requirements and limitations, like the one mentioned in the Spock&#8217;s documentation:<sup class="footnote">[<a id="_footnoteref_1" class="footnote" href="#_footnotedef_1" title="View footnote.">1</a>]</sup></p></div><div class="quoteblock"><blockquote><div class="paragraph"><p>The <code>when</code> and <code>then</code> blocks always occur together. They describe a stimulus and the expected response. Whereas <code>when</code> blocks may contain arbitrary code, <code>then</code> blocks are restricted to <em>conditions</em>, <em>exception conditions</em>, <em>interactions</em>, and <em>variable definitions</em>. A feature method may contain multiple pairs of <code>when</code>-<code>then</code> blocks.</p></div></blockquote></div><div class="paragraph"><p>It states clearly what 4 kinds of statements we can use inside <code>then</code> block. Let&#8217;s take a closer look at all of them.</p></div><div class="sect2"><h3 id="1-conditions">1. Conditions</h3><div class="listingblock"><div class="title">Listing 1. An example of the condition in the then block</div><div class="content"><pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">then:
expected == result</code></pre></div></div><div class="paragraph"><p>This is a simple expression that compares some <code>result</code> with <code>expected</code> value, which was defined most probably in the <code>given</code> or <code>setup</code> block.</p></div></div><div class="sect2"><h3 id="2-exception-conditions">2. Exception conditions</h3><div class="listingblock"><div class="title">Listing 2. An example of an exception condition in the then block</div><div class="content"><pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">then:
thrown IllegalArgumentException</code></pre></div></div><div class="paragraph"><p>In this example we define expectation - an exception of a specific type has to be thrown.</p></div></div><div class="sect2"><h3 id="3-interactions">3. Interactions</h3><div class="listingblock"><div class="title">Listing 3. An example of interaction expectation in the then block</div><div class="content"><pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">then:
1 * foo.bar() &gt;&gt; "Hello!"</code></pre></div></div><div class="paragraph"><p>In this example, we say that we expect that <code>foo.bar()</code> method gets called exactly one time, and it returns <code>"Hello"</code> value.</p></div></div><div class="sect2"><h3 id="4-variable-definitions">4. Variable definitions</h3><div class="listingblock"><div class="title">Listing 4. An example of variable definition in the then block</div><div class="content"><pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">then:
def expected = 10
result == expected</code></pre></div></div><div class="paragraph"><p>So here&#8217;s the last available statement type - variable definition. As you can see you can define any variable inside the <code>then</code> block, however, this is not a good practice. The <code>then</code> block should be as small and smooth as possible, and this variable definition adds nothing else than noise. In some specific use cases, it might make more sense to do so, but it&#8217;s usually a better choice to consider <code>given</code> or <code>setup</code> blocks for variable definitions.</p></div></div></div></div><div class="sect1"><h2 id="using-if-statement-in-the-then-block">Using if-statement in the <code>then</code> block</h2><div class="sectionbody"><div class="paragraph"><p>Now when we have recapped basic concepts of Spock&#8217;s <code>then</code> block structure, let&#8217;s take a look at some unusual example. Below you can find a simple Spock unit test that contains 3 methods. The expectation is that all of them fail because of unsatisfied assertion.</p></div><div class="listingblock"><div class="title">Listing 5. All of these test methods should fail</div><div class="content"><pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">import groovy.transform.CompileStatic
import spock.lang.Specification

@CompileStatic
class SpockThenSpecialUseCase extends Specification {

    def "(1) should fail on expected == result comparison"() {
        given:
        def expected = "Hello, John!"

        when:
        def result = "Hello, Joe!"

        then:
        expected == result
    }

    def "(2) should fail on expected == result comparison"() {
        given:
        def expected = "Hello, John!"

        when:
        def result = "Hello, Joe!"

        then:
        if (expected) {
            expected == result
        }
    }

    def "(3) should fail on expected == result comparison"() {
        given:
        def expected = "Hello, John!"

        when:
        def result = "Hello, Joe!"

        then:
        if (expected) {
            assert expected == result
        }
    }
}</code></pre></div></div><div class="paragraph"><p>When we run this test we will see the following result:</p></div><div class="openblock text-center"><div class="content"><div class="imageblock img-responsive img-thumbnail"><div class="content"><a class="image" href="/images/spock-then-if-assertion.png"><div class="img-lazyload-container" style="width:939px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==);background-repeat:no-repeat;background-position:center"><img data-original="/images/spock-then-if-assertion.png" height="261" width="939" style="padding-top:27.79552715654952%"></div></a></div></div></div></div><div class="paragraph"><p>The second test case didn&#8217;t fail as expected. The answer is clear and straightforward - if-statement does not fit to any of 4 statements we have described in the previous section.</p></div></div></div><div class="sect1"><h2 id="looking-for-an-answer">Looking for an answer</h2><div class="sectionbody"><div class="paragraph"><p>I&#8217;m pretty sure this simple answer does not satisfy your pursuit to better understanding what happens under the hood. Let&#8217;s dig one level down and see what the decompiled bytecode of this class looks like.</p></div><div class="listingblock"><div class="title">Listing 6. Spock test decompiled from <code>.class</code> file to Java</div><div class="content"><pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">//
// Source code recreated from a .class file by IntelliJ IDEA
// (powered by Fernflower decompiler)
//

import groovy.lang.GroovyObject;
import org.codehaus.groovy.runtime.ScriptBytecodeAdapter;
import org.codehaus.groovy.runtime.typehandling.DefaultTypeTransformation;
import org.spockframework.runtime.ErrorCollector;
import org.spockframework.runtime.SpockRuntime;
import org.spockframework.runtime.ValueRecorder;
import org.spockframework.runtime.model.BlockKind;
import org.spockframework.runtime.model.BlockMetadata;
import org.spockframework.runtime.model.FeatureMetadata;
import org.spockframework.runtime.model.SpecMetadata;
import spock.lang.Specification;

@SpecMetadata(
    filename = "SpockThenSpecialUseCase.groovy",
    line = 4
)
public class SpockThenSpecialUseCase extends Specification implements GroovyObject {
    public SpockThenSpecialUseCase() {
    }

    @FeatureMetadata(
        line = 7,
        name = "(1) should fail on expected == result comparison",
        ordinal = 0,
        blocks = {@BlockMetadata(
    kind = BlockKind.SETUP,
    texts = {}
), @BlockMetadata(
    kind = BlockKind.WHEN,
    texts = {}
), @BlockMetadata(
    kind = BlockKind.THEN,
    texts = {}
)},
        parameterNames = {}
    )
    public void $spock_feature_0_0() { <i class="conum" data-value="1"></i><b>(1)</b>
        ErrorCollector $spock_errorCollector = new ErrorCollector(false);
        ValueRecorder $spock_valueRecorder = new ValueRecorder();

        Object var10000;
        try {
            String expected = "Hello, John!";
            String result = "Hello, Joe!";

            try {
                SpockRuntime.verifyCondition($spock_errorCollector, $spock_valueRecorder.reset(), "expected == result", Integer.valueOf(15), Integer.valueOf(9), (Object)null, $spock_valueRecorder.record($spock_valueRecorder.startRecordingValue(Integer.valueOf(2)), ScriptBytecodeAdapter.compareEqual($spock_valueRecorder.record($spock_valueRecorder.startRecordingValue(Integer.valueOf(0)), expected), $spock_valueRecorder.record($spock_valueRecorder.startRecordingValue(Integer.valueOf(1)), result))));
                var10000 = null;
            } catch (Throwable var14) {
                SpockRuntime.conditionFailedWithException($spock_errorCollector, $spock_valueRecorder, "expected == result", Integer.valueOf(15), Integer.valueOf(9), (Object)null, var14);
                var10000 = null;
            } finally {
                ;
            }

            ScriptBytecodeAdapter.invokeMethod0(SpockThenSpecialUseCase.class, ((SpockThenSpecialUseCase)this).getSpecificationContext().getMockController(), (String)"leaveScope");
        } finally {
            $spock_errorCollector.validateCollectedErrors();
            var10000 = null;
        }

    }

    @FeatureMetadata(
        line = 18,
        name = "(2) should fail on expected == result comparison",
        ordinal = 1,
        blocks = {@BlockMetadata(
    kind = BlockKind.SETUP,
    texts = {}
), @BlockMetadata(
    kind = BlockKind.WHEN,
    texts = {}
), @BlockMetadata(
    kind = BlockKind.THEN,
    texts = {}
)},
        parameterNames = {}
    )
    public void $spock_feature_0_1() { <i class="conum" data-value="2"></i><b>(2)</b>
        String expected = "Hello, John!";
        String result = "Hello, Joe!";
        if (DefaultTypeTransformation.booleanUnbox(expected)) {
            ScriptBytecodeAdapter.compareEqual(expected, result);
        }

        ScriptBytecodeAdapter.invokeMethod0(SpockThenSpecialUseCase.class, ((SpockThenSpecialUseCase)this).getSpecificationContext().getMockController(), (String)"leaveScope");
    }

    @FeatureMetadata(
        line = 31,
        name = "(3) should fail on expected == result comparison",
        ordinal = 2,
        blocks = {@BlockMetadata(
    kind = BlockKind.SETUP,
    texts = {}
), @BlockMetadata(
    kind = BlockKind.WHEN,
    texts = {}
), @BlockMetadata(
    kind = BlockKind.THEN,
    texts = {}
)},
        parameterNames = {}
    )
    public void $spock_feature_0_2() { <i class="conum" data-value="3"></i><b>(3)</b>
        ErrorCollector $spock_errorCollector = new ErrorCollector(false);
        ValueRecorder $spock_valueRecorder = new ValueRecorder();

        Object var10000;
        try {
            String expected = "Hello, John!";
            String result = "Hello, Joe!";
            if (DefaultTypeTransformation.booleanUnbox(expected)) {
                try {
                    SpockRuntime.verifyCondition($spock_errorCollector, $spock_valueRecorder.reset(), "expected == result", Integer.valueOf(40), Integer.valueOf(20), (Object)null, $spock_valueRecorder.record($spock_valueRecorder.startRecordingValue(Integer.valueOf(2)), ScriptBytecodeAdapter.compareEqual($spock_valueRecorder.record($spock_valueRecorder.startRecordingValue(Integer.valueOf(0)), expected), $spock_valueRecorder.record($spock_valueRecorder.startRecordingValue(Integer.valueOf(1)), result))));
                    var10000 = null;
                } catch (Throwable var14) {
                    SpockRuntime.conditionFailedWithException($spock_errorCollector, $spock_valueRecorder, "expected == result", Integer.valueOf(40), Integer.valueOf(20), (Object)null, var14);
                    var10000 = null;
                } finally {
                    ;
                }
            }

            ScriptBytecodeAdapter.invokeMethod0(SpockThenSpecialUseCase.class, ((SpockThenSpecialUseCase)this).getSpecificationContext().getMockController(), (String)"leaveScope");
        } finally {
            $spock_errorCollector.validateCollectedErrors();
            var10000 = null;
        }

    }
}</code></pre></div></div><div class="paragraph"><p>The Java code doesn&#8217;t look as smooth as Groovy one, but we can quickly spot the most interesting parts. The method <em class="conum" data-value="1"></em> shows what does the decompiled bytecode representation looks like. We can see that the following Spock part:</p></div><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">then:
expected == result</code></pre></div></div><div class="paragraph"><p>gets replaced by something like this (method call formatted for better readability):</p></div><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">SpockRuntime.verifyCondition(
    $spock_errorCollector,
    $spock_valueRecorder.reset(),
    "expected == result",
    Integer.valueOf(15),
    Integer.valueOf(9),
    (Object)null,
    $spock_valueRecorder.record(
        $spock_valueRecorder.startRecordingValue(Integer.valueOf(2)),
        ScriptBytecodeAdapter.compareEqual(
            $spock_valueRecorder.record($spock_valueRecorder.startRecordingValue(Integer.valueOf(0)), expected),
            $spock_valueRecorder.record($spock_valueRecorder.startRecordingValue(Integer.valueOf(1)), result)
        )
    )
);</code></pre></div></div><div class="paragraph"><p>Spock uses its custom compiler which modifies abstract syntax tree (AST) of your unit test. It checks if the <code>then</code> (and any other) block meets requirements and rewrites it. There are two methods we could start investigation from to get a better understanding of what Spock does under the hood:</p></div><div class="ulist"><ul><li><p><a href="https://github.com/spockframework/spock/blob/spock-1.2/spock-core/src/main/java/org/spockframework/compiler/SpecRewriter.java#L322-L338" target="_blank" rel="noopener"><code>org.spockframework.compiler.SpecRewriter.visitThenBlock()</code></a></p></li><li><p><a href="https://github.com/spockframework/spock/blob/spock-1.2/spock-core/src/main/java/org/spockframework/compiler/DeepBlockRewriter.java#L141-L164" target="_blank" rel="noopener"><code>org.spockframework.compiler.DeepBlockRewriter.handleImplicitCondition()</code></a></p></li></ul></div><div class="paragraph"><p>Now, let&#8217;s take a quick look at the <em class="conum" data-value="2"></em> test case that used if-statement inside the <code>then</code> block and passed:</p></div><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public void $spock_feature_0_1() {
    String expected = "Hello, John!";
    String result = "Hello, Joe!";
    if (DefaultTypeTransformation.booleanUnbox(expected)) {
        ScriptBytecodeAdapter.compareEqual(expected, result);
    }

    ScriptBytecodeAdapter.invokeMethod0(SpockThenSpecialUseCase.class, ((SpockThenSpecialUseCase)this).getSpecificationContext().getMockController(), (String)"leaveScope");
}</code></pre></div></div><div class="paragraph"><p>It looks like not a single line of code got modified the AST. It happened because Spock&#8217;s compiler didn&#8217;t find a valid statement for a <code>then</code> block and thus it didn&#8217;t have to rewrite anything.</p></div><div class="paragraph"><p>A different situation takes place in the example <em class="conum" data-value="3"></em>. Here we have called <code>assert</code> explicitly, and it was an explicit instruction for Spock&#8217;s compiler to modify AST. The if-statement is still here, but the following part:</p></div><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">then:
if (expected) {
    assert expected == result
}</code></pre></div></div><div class="paragraph"><p>was compiled to a following code (decompiled Java representation):</p></div><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">if (DefaultTypeTransformation.booleanUnbox(expected)) {
    try {
        SpockRuntime.verifyCondition(
            $spock_errorCollector,
            $spock_valueRecorder.reset(),
            "expected == result",
            Integer.valueOf(40),
            Integer.valueOf(20),
            (Object)null,
            $spock_valueRecorder.record(
                $spock_valueRecorder.startRecordingValue(Integer.valueOf(2)),
                ScriptBytecodeAdapter.compareEqual(
                    $spock_valueRecorder.record($spock_valueRecorder.startRecordingValue(Integer.valueOf(0)), expected),
                    $spock_valueRecorder.record($spock_valueRecorder.startRecordingValue(Integer.valueOf(1)), result)
                )
            )
        );
        var10000 = null;
    } catch (Throwable var14) {
        SpockRuntime.conditionFailedWithException($spock_errorCollector, $spock_valueRecorder, "expected == result", Integer.valueOf(40), Integer.valueOf(20), (Object)null, var14);
        var10000 = null;
    } finally {
        ;
    }
}</code></pre></div></div><div class="paragraph"><p>As we can see Spock understands explicit <code>assert</code> instruction and passes its condition to&nbsp;a&nbsp; <code>SpockRuntime.verifyCondition()</code> method as shown above.</p></div></div></div><div class="sect1"><h2 id="conclusion">Conclusion</h2><div class="sectionbody"><div class="paragraph"><p>I hope you find this article interesting. Don&#8217;t hesitate to leave a comment in the section below. Maybe you have experienced some unexpected Spock behavior - please share your story with the rest of us. Take care and see you next time!</p></div><h2 id="thank-you" class="discrete">Thank you!</h2><div class="paragraph"><p>If you read up to this point - leave me a comment below, so I can <strong>thank you</strong> in person for such an engagement. You can also share this blog post on <span class="icon color-twitter"><i class="fa fa-twitter"></i></span> <a href="https://twitter.com/intent/tweet?text=%22Spock%20assertion%20inside%20if-statement%20doesn't%20work%20-%20why?%22%20https://e.printstacktrace.blog/spock-assertion-inside-if-statement-doesnt-work-why/%20via%20@wololock" target="_blank" rel="noopener">Twitter</a>, <span class="icon color-facebook"><i class="fa fa-facebook-square"></i></span> <a href="https://www.facebook.com/sharer/sharer.php?u=https://e.printstacktrace.blog/spock-assertion-inside-if-statement-doesnt-work-why/&t=Spock%20assertion%20inside%20if-statement%20doesn't%20work%20-%20why?" target="_blank" rel="noopener">Facebook</a>, or <span class="icon color-linkedin"><i class="fa fa-linkedin-square"></i></span> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https://e.printstacktrace.blog/spock-assertion-inside-if-statement-doesnt-work-why/&title=Spock%20assertion%20inside%20if-statement%20doesn't%20work%20-%20why?" target="_blank" rel="noopener">LinkedIn</a> if you think other people can benefit from reading it. Thanks in advance!</p></div><div class="paragraph"><p>PS: Creating high-quality content takes a lot of time and effort. I want to deliver the best possible value to my readers and keep the blog always <strong>ad-free</strong>. If you have two more minutes, please take a look at this dedicated page where I listed a few different options to <a href="https://e.printstacktrace.blog/support-me" class="ga-track">support my efforts</a>. If my vision for the <em>e.printstacktrace.blog</em> development resonates with you, I will be grateful if you consider supporting me in this journey. <strong>Thank you! <span class="icon color-red"><i class="fa fa-heart"></i></span></strong></p></div></div></div><div id="footnotes"><hr><div class="footnote" id="_footnotedef_1"><a href="#_footnoteref_1">1</a>. <a href="http://spockframework.org/spock/docs/1.2/spock_primer.html#_when_and_then_blocks" target="_blank" rel="noopener" class="bare">http://spockframework.org/spock/docs/1.2/spock_primer.html#_when_and_then_blocks</a></div></div><footer class="post-footer"><img class="img-responsive img-circle" src="https://www.gravatar.com/avatar/b22c1842c6e8f7f2b9b3ed8c0d4efb4d?s=200"><div class="row author"><div class="col-lg-8 col-lg-offset-2 col-xs-10 col-xs-offset-1"><h4>Szymon Stepniak</h4><p><a class="stack-overflow" href="https://stackoverflow.com/users/2194470/szymon-stepniak?tab=profile" target="_blank" rel="noopener"><img class="so-icon" src="/img/so.png"><b class="rep">27,243</b><span class="badges"><span class="gold"><span class="b">●</span><span class="c">9</span></span><span class="silver"><span class="b">●</span><span class="c">61</span></span><span class="bronze"><span class="b">●</span><span class="c">94</span></span></span></a></p><p>Groovista, Upwork's Top Rated freelancer, Toruń Java User Group founder, open&nbsp;source contributor, Stack Overflow addict, bedroom guitar player. I walk through e.printStackTrace() so you don't have to.</p><ul class="social-links"><li><a href="https://feeds.feedburner.com/Eprintstacktracenet" target="_blank" rel="noopener" onclick="return window.open(this.href),!1"><span class="fa fa-rss"></span></a></li><li><a href="https://twitter.com/wololock" target="_blank" rel="noopener" onclick="return window.open(this.href),!1"><span class="fa fa-twitter"></span></a></li><li><a href="https://github.com/wololock" target="_blank" rel="noopener" onclick="return window.open(this.href),!1"><span class="fa fa-github"></span></a></li><li><a href="https://stackoverflow.com/users/2194470/szymon-stepniak?tab=profile" target="_blank" rel="noopener" onclick="return window.open(this.href),!1"><span class="fa fa-stack-overflow"></span></a></li><li><a href="https://www.youtube.com/c/eprintstacktrace" target="_blank" rel="noopener" onclick="return window.open(this.href),!1"><span class="fa fa-youtube"></span></a></li><li><a href="mailto:szymon.stepniak@gmail.com" onclick="return window.open(this.href),!1"><span class="fa fa-envelope"></span></a></li><li><a href="https://www.linkedin.com/in/szymon-stępniak-9a0b1630" target="_blank" rel="noopener" onclick="return window.open(this.href),!1"><span class="fa fa-linkedin"></span></a></li><li><a href="https://keybase.io/wololock" target="_blank" rel="noopener" onclick="return window.open(this.href),!1"><span class="fa fa-user-secret"></span></a></li></ul></div></div></footer><section class="related-posts"><h2>You may also like</h2><div class="row"><div class="col-lg-4"><a href="/spock-random-order-of-tests-how-to/"><img class="img-responsive" src="/images/og/spock-random-tests.jpg"><h3>Spock random order of tests - how to?</h3></a><p>Spock Framework executes test methods (features) in a single class (specification) in the declaration order. There is nothing wrong in this default behavior - we should write tests with their isola...</p></div><div class="col-lg-4"><a href="/graalvm-and-groovy-how-to-start/"><img class="img-responsive" src="/images/og/graalvm-groovy-how-to-start2.jpg"><h3>GraalVM and Groovy - how to start?</h3></a><p>GraalVM became one of the most popular topics in the JVM ecosystem. It promises the highest possible speed of running JVM-based programs (when compiled to native images), hand in hand with the smal...</p></div><div class="col-lg-4"><a href="/junit-assume-notnull-throws-nullpointerexception-in-groovy-whats-wrong/"><img class="img-responsive" src="/images/og/groovy-junit-assume-notnull-npe.jpg"><h3>JUnit Assume.assumeNotNull(obj) throws NullPointerException in Groovy - what's wrong?</h3></a><p>Ignoring some of the unit tests when given conditions are not satisfied is a handy feature of a JUnit framework. I guess you have used many times constructions like Assume.assumeTrue(expr) or Assum...</p></div></div></section></article><nav class="pagination" role="pagination"><a class="pull-left btn" href="/programming-groovy-2-book-review/">← Next post</a><a class="pull-right btn" href="/junit-assume-notnull-throws-nullpointerexception-in-groovy-whats-wrong/">Previous post →</a></nav><div class="disqus-comments"><div class="comments"><div id="disqus_thread"><div id="disqus_empty" style="display:none">Empty</div></div></div></div><script>function load_disqus(e){var t=document.getElementById("disqus_empty");if(document.contains(t)){var n=document.getElementById("disqus_thread"),d=document.createElement("script"),s=document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0];n&&t&&(t.remove(),d.type="text/javascript",d.async=!0,d.src="//"+e+".disqus.com/embed.js",s.appendChild(d))}}window.addEventListener("scroll",function(e){document.scrollingElement.scrollTop>document.getElementById("disqus_thread").getBoundingClientRect().top+350&&load_disqus("eprintstacktrace")},!1)</script></div></div></div><script async id="dsq-count-scr" src="//eprintstacktrace.disqus.com/count.js"></script><footer class="site-footer"><div class="container-fluid"><div class="row"><div class="col-lg-10 col-lg-offset-1 col-xs-10 col-xs-offset-1"><div class="row"><div class="col-lg-4"><h4 class="marked">Recent video on YouTube</h4><section class="recent-posts"><a href="https://www.youtube.com/watch?v=vJgcsyLJf0g" target="_blank" rel="noopener"><img class="img-thumbnail img-noborder" src="https://i3.ytimg.com/vi/vJgcsyLJf0g/mqdefault.jpg" alt="Brainf**k interpreter in Groovy (tail recursive implementation) | #groovylang"></a></section><h4>e.printstacktrace.blog © 2020</h4><p><em>"I walk through e.printStackTrace() so you don't have to"</em></p></div><div class="col-lg-4"><h4 class="marked">Recent articles</h4><section class="recent-posts"><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/how-to-time-out-jenkins-pipeline-stage-and-keep-the-pipeline-running/">How to time out Jenkins Pipeline stage and keep the pipeline running?</a></li><li class="post-list-item"><a class="post-list-link" href="/my-first-200-youtube-subscribers-thank-you/">My first 200 YouTube subscribers - Thank You!</a></li><li class="post-list-item"><a class="post-list-link" href="/groovy-dynamic-maps-generic-type-erasure-and-raw-types/">Groovy dynamic Maps, generic type erasure, and raw types - an interesting use case to learn from</a></li><li class="post-list-item"><a class="post-list-link" href="/groovy-3-nullcheck-annotation-less-code-and-less-npe/">Groovy 3 @NullCheck annotation - less code and less NPE</a></li><li class="post-list-item"><a class="post-list-link" href="/groovy-3-string-gdk-improvements-takeright-takebetween-and-a-few-others/">Groovy 3 String GDK improvements - takeRight, takeBetween, and a few others</a></li><li class="post-list-item"><a class="post-list-link" href="/jenkins-scripted-pipeline-vs-declarative-pipeline-the-4-practical-differences/">Jenkins Scripted Pipeline vs. Declarative Pipeline - the 4 practical differences</a></li></ul></section></div><div class="col-lg-4"><h4 class="marked">Stay connected</h4><div class="social-links"><ul><li><a href="https://feeds.feedburner.com/Eprintstacktracenet" target="_blank" rel="noopener" onclick="return window.open(this.href),!1"><span class="fa fa-rss"></span></a></li><li><a href="https://twitter.com/wololock" target="_blank" rel="noopener" onclick="return window.open(this.href),!1"><span class="fa fa-twitter"></span></a></li><li><a href="https://github.com/wololock" target="_blank" rel="noopener" onclick="return window.open(this.href),!1"><span class="fa fa-github"></span></a></li><li><a href="https://stackoverflow.com/users/2194470/szymon-stepniak?tab=profile" target="_blank" rel="noopener" onclick="return window.open(this.href),!1"><span class="fa fa-stack-overflow"></span></a></li><li><a href="https://www.youtube.com/c/eprintstacktrace" target="_blank" rel="noopener" onclick="return window.open(this.href),!1"><span class="fa fa-youtube"></span></a></li><li><a href="mailto:szymon.stepniak@gmail.com" onclick="return window.open(this.href),!1"><span class="fa fa-envelope"></span></a></li><li><a href="https://www.linkedin.com/in/szymon-stępniak-9a0b1630" target="_blank" rel="noopener" onclick="return window.open(this.href),!1"><span class="fa fa-linkedin"></span></a></li><li><a href="https://keybase.io/wololock" target="_blank" rel="noopener" onclick="return window.open(this.href),!1"><span class="fa fa-user-secret"></span></a></li></ul></div><h4 class="marked">Most popular tags</h4><section class="tagcloud"><a href="/t/affiliate/" style="font-size:12pt;color:#777">affiliate</a> <a href="/t/benchmark/" style="font-size:12pt;color:#777">benchmark</a> <a href="/t/book/" style="font-size:16pt;color:#858585">book</a> <a href="/t/cicd/" style="font-size:24pt;color:#9f9f9f">cicd</a> <a href="/t/devops/" style="font-size:12pt;color:#777">devops</a> <a href="/t/docker/" style="font-size:12pt;color:#777">docker</a> <a href="/t/github/" style="font-size:8pt;color:#6a6a6a">github</a> <a href="/t/graalvm/" style="font-size:24pt;color:#9f9f9f">graalvm</a> <a href="/t/groovy/" style="font-size:32pt;color:#bababa">groovy</a> <a href="/t/haskell/" style="font-size:8pt;color:#6a6a6a">haskell</a> <a href="/t/java/" style="font-size:28pt;color:#adadad">java</a> <a href="/t/jenkins/" style="font-size:20pt;color:#929292">jenkins</a> <a href="/t/jenkins-pipeline/" style="font-size:20pt;color:#929292">jenkins-pipeline</a> <a href="/t/jmh/" style="font-size:16pt;color:#858585">jmh</a> <a href="/t/maven/" style="font-size:8pt;color:#6a6a6a">maven</a> <a href="/t/micronaut/" style="font-size:12pt;color:#777">micronaut</a> <a href="/t/native-image/" style="font-size:12pt;color:#777">native-image</a> <a href="/t/non-blocking/" style="font-size:12pt;color:#777">non-blocking</a> <a href="/t/ratpack/" style="font-size:24pt;color:#9f9f9f">ratpack</a> <a href="/t/recursion/" style="font-size:8pt;color:#6a6a6a">recursion</a> <a href="/t/review/" style="font-size:16pt;color:#858585">review</a> <a href="/t/sdkman/" style="font-size:12pt;color:#777">sdkman</a> <a href="/t/spock/" style="font-size:12pt;color:#777">spock</a> <a href="/t/stackoverflow/" style="font-size:8pt;color:#6a6a6a">stackoverflow</a> <a href="/t/unit-test/" style="font-size:12pt;color:#777">unit-test</a></section></div></div></div></div><div class="row"><div class="col-lg-10 col-lg-offset-1 col-xs-10 col-xs-offset-1 text-center"><ul class="footer-links"><li><a href="/privacy-policy/">Privacy policy</a></li><li><a href="/support-me/">Support me</a></li><li><a href="http://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener"><img src="https://badgen.net/badge/license/CC%20BY-NC-SA%204.0/gray"></a></li><li><a href="https://github.com/wololock/wololock.github.io/commits/develop" target="_blank" rel="noopener"><img src="https://badgen.net/github/last-commit/wololock/wololock.github.io?color=blue"></a></li></ul></div></div></div><section class="poweredby"><ul class="text-center"><li><span>Published with </span><a href="https://hexo.io" target="_blank" rel="noopener" onclick="return window.open(this.href),!1"><img src="/img/logo-hexo.png"></a></li><li><span>Hosted on </span><a href="https://github.com/wololock/wololock.github.io" target="_blank" rel="noopener" onclick="return window.open(this.href),!1"><img src="/img/logo-github.png"></a></li><li><span>Deployed with </span><a href="https://circleci.com/gh/wololock/wololock.github.io" target="_blank" rel="noopener" onclick="return window.open(this.href),!1"><img src="/img/logo-circleci.png"></a></li></ul></section></footer><script src="//cdnjs.cloudflare.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script><script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script><script async id="cookiebanner" src="//cdnjs.cloudflare.com/ajax/libs/cookie-banner/1.2.2/cookiebanner.min.js" data-moreinfo="/privacy-policy/" data-message="This blog uses cookies to enhance your experience. By continuing to visit it you agree to its use of cookies." data-link="#ffad33" data-font-family="Lora,serif" data-font-size="1.6rem" data-bg="#444"></script><script src="/js/main.js?v=5"></script><script src="/js/highlight.pack.js?v=9.18.1"></script><script>hljs.initHighlightingOnLoad()</script><script>"localhost"!==window.location.hostname&&"127.0.0.1"!==window.location.hostname&&(!function(a,e,t,n,o,c,i){a.GoogleAnalyticsObject=o,a.ga=a.ga||function(){(a.ga.q=a.ga.q||[]).push(arguments)},a.ga.l=1*new Date,c=e.createElement(t),i=e.getElementsByTagName(t)[0],c.async=1,c.src="//www.google-analytics.com/analytics.js",i.parentNode.insertBefore(c,i)}(window,document,"script",0,"ga"),ga("create","UA-42400890-5","auto"),ga("send","pageview"),jQuery("a.ga-track").click(function(a){var e=jQuery(a.target).text();return ga("send","event","affiliate","click",e),!0}))</script><script>!function(){"use strict";function r(e){var t=e.getAttribute("data-original"),n=new Image;n.onload=function(){e.setAttribute("src",t),e.style.paddingTop=""},n.src=t}document.addEventListener("DOMContentLoaded",function(){var t,e,n,i=Array.prototype.slice.call(document.querySelectorAll("img[data-original]"));i.length&&("undefined"!=typeof IntersectionObserver?(t=new IntersectionObserver(function(e,t){e.filter(function(e){return e.isIntersecting}).forEach(function(e){r(e.target),t.unobserve(e.target)})}),i.forEach(function(e){t.observe(e)})):(n=function(){clearTimeout(e),e=setTimeout(function(){if(!(i=i.filter(function(e){return!e.src})).length)return window.removeEventListener("scroll",n),void window.removeEventListener("resize",n);i.filter(function(e){e.getBoundingClientRect().top<window.innerHeight&&r(e)})},100)},window.addEventListener("scroll",n),window.addEventListener("resize",n),n()))},!1)}();</script></body></html>